<script>
// Handle Add Brand Form Submission with Limit Check
document.addEventListener('DOMContentLoaded', function() {
  const brandForm = document.querySelector('#brandModal form');
  const categoryForm = document.querySelector('#categoriesModal form');
  const inventoryForm = document.querySelector('#gadgetrModal form');
  const repairForm = document.querySelector('#gadgetRepairModal form');
  
  if (brandForm && !brandForm.dataset.listenerAttached) {
    brandForm.dataset.listenerAttached = 'true';
    brandForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('/Brand', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: new URLSearchParams(formData)
        });
        
        const data = await response.json();
        
        if (data.limitReached) {
          Swal.fire({
            icon: 'warning',
            title: 'Limit Reached!',
            html: `<p>${data.message}</p><p style="margin-top: 10px;">Upgrade your plan to add more brands.</p>`,
            confirmButtonText: 'Upgrade Plan',
            showCancelButton: true,
            cancelButtonText: 'Close',
            confirmButtonColor: '#00C853',
            cancelButtonColor: '#6c757d'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = '/pricing';
            }
          });
        } else if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: data.message || 'Brand added successfully',
            confirmButtonColor: '#00C853'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: data.message || 'Failed to add brand',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        console.error('Brand error:', error);
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Brand added successfully',
          confirmButtonColor: '#00C853'
        }).then(() => {
          window.location.reload();
        });
      }
    });
  }
  
  if (categoryForm && !categoryForm.dataset.listenerAttached) {
    categoryForm.dataset.listenerAttached = 'true';
    categoryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('/category', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: new URLSearchParams(formData)
        });
        
        const data = await response.json();
        
        if (data.limitReached) {
          Swal.fire({
            icon: 'warning',
            title: 'Limit Reached!',
            html: `<p>${data.message}</p><p style="margin-top: 10px;">Upgrade your plan to add more categories.</p>`,
            confirmButtonText: 'Upgrade Plan',
            showCancelButton: true,
            cancelButtonText: 'Close',
            confirmButtonColor: '#00C853',
            cancelButtonColor: '#6c757d'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = '/pricing';
            }
          });
        } else if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: data.message || 'Category added successfully',
            confirmButtonColor: '#00C853'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: data.message || 'Failed to add category',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        console.error('Category error:', error);
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Category added successfully',
          confirmButtonColor: '#00C853'
        }).then(() => {
          window.location.reload();
        });
      }
    });
  }
  
  if (inventoryForm && !inventoryForm.dataset.listenerAttached) {
    inventoryForm.dataset.listenerAttached = 'true';
    inventoryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('/in_stock', {
          method: 'POST',
          headers: {'Accept': 'application/json'},
          body: formData
        });
        
        const data = await response.json();
        
        if (data.limitReached) {
          Swal.fire({
            icon: 'warning',
            title: 'Limit Reached!',
            html: `<p>${data.message}</p><p style="margin-top: 10px;">Upgrade your plan to add more inventory items.</p>`,
            confirmButtonText: 'Upgrade Plan',
            showCancelButton: true,
            cancelButtonText: 'Close',
            confirmButtonColor: '#00C853',
            cancelButtonColor: '#6c757d'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = '/pricing';
            }
          });
        } else if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: data.message || 'Inventory item added successfully',
            confirmButtonColor: '#00C853'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: data.message || 'Failed to add inventory item',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'Something went wrong. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      }
    });
  }
  
  if (repairForm && !repairForm.dataset.listenerAttached) {
    repairForm.dataset.listenerAttached = 'true';
    let isSubmitting = false;
    const submitBtn = repairForm.querySelector('button[type="submit"]');
    
    repairForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (isSubmitting) {
        console.log('⚠️ Duplicate submission blocked');
        return;
      }
      
      console.log('✅ Starting repair submission');
      isSubmitting = true;
      
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Adding...';
      }
      
      const formData = new FormData(this);
      
      try {
        const response = await fetch('/repair', {
          method: 'POST',
          headers: {'Accept': 'application/json'},
          body: formData
        });
        
        const data = await response.json();
        
        if (data.limitReached) {
          isSubmitting = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fa-solid fa-tools me-2"></i>Create Repair Request';
          }
          Swal.fire({
            icon: 'warning',
            title: 'Limit Reached!',
            html: `<p>${data.message}</p><p style="margin-top: 10px;">Upgrade your plan to add more repair customers.</p>`,
            confirmButtonText: 'Upgrade Plan',
            showCancelButton: true,
            cancelButtonText: 'Close',
            confirmButtonColor: '#00C853',
            cancelButtonColor: '#6c757d'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = '/pricing';
            }
          });
        } else if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: data.message || 'Repair customer added successfully',
            confirmButtonColor: '#00C853'
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: data.message || 'Failed to add repair customer',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        isSubmitting = false;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Add Repair Customer';
        }
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'Something went wrong. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      }
    });
  }
});
</script>
