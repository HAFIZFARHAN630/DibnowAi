<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Request</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    
    <!-- Template Stylesheet -->
     <link href="/bootstrap.css" rel="stylesheet">
    <link href="\styles.css" rel="stylesheet">
    <link href="\styles1.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    

    <style>
      .body-wrapper {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* Enhanced Table Design - Same as adminfile.ejs */
      .table {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: none;
      }

      .table thead th {
        background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%) !important;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        padding: 20px 15px;
        font-size: 14px;
      }

      .table tbody tr {
        transition: all 0.3s ease;
        border: none;
      }

      .table tbody tr:hover {
        background-color: #f8f9ff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .table tbody td {
        padding: 18px 15px;
        border: none;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
      }

      /* Colorful Transaction ID and Amount */
      .transaction-id {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-block;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }

      .amount-value {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1rem;
        display: inline-block;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      }

      .table tbody tr.search-hidden {
        display: none;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .no-results i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      /* Enhanced Button Styling */
      .accept-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        border: 2px solid rgba(16, 185, 129, 0.3) !important;
        border-radius: 25px !important;
        color: white !important;
        font-weight: 600 !important;
        padding: 8px 20px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3) !important;
      }

      .accept-btn:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4) !important;
        color: white !important;
      }

      .accept-btn:disabled {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
        transform: none !important;
        box-shadow: none !important;
      }

      .deny-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        border: 2px solid rgba(239, 68, 68, 0.3) !important;
        border-radius: 25px !important;
        color: white !important;
        font-weight: 600 !important;
        padding: 8px 20px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3) !important;
      }

      .deny-btn:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important;
        color: white !important;
      }
      @media screen and (max-width:786px) {
        .hiden-on-small{
          display: none;
        }
      }

      /* Professional Pagination Buttons */
      .pagination .page-link {
        background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%) !important;
        color: white !important;
        border: none !important;
        font-weight: 600 !important;
        padding: 10px 24px !important;
        min-width: 120px !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 8px rgba(0, 51, 204, 0.3) !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .pagination .page-link:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0, 51, 204, 0.4) !important;
      }

      .pagination .page-item.disabled .page-link {
        background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%) !important;
        opacity: 0.6 !important;
        cursor: not-allowed !important;
      }

      .pagination .page-item {
        margin: 0 4px !important;
      }
    </style>

</head>
<body>

   <%- include('../par/sidebar.ejs') %>
        <%- include('../par/header.ejs') %>
    <div class="body-wrapper">
       


        <div class="main-content">
      <div class="container-fluid">
          <div class="card card-body py-3">
              <div class="row align-items-center">
                  <div class="col-md-12">
                      <div class="d-flex justify-content-center align-items-center">
                          <h4 class="mb-4 mb-sm-0 card-title fs-6 fw-bold"> User  Manual-Payment Request</h4>
                
                      </div>
                  </div>
              </div>
          </div>
        
          <div class="">
            <div class="w-full">

  <!-- TABLE: visible at width >= 1200px -->
  <div class="hidden min-[1200px]:block">
    <div class="overflow-hidden rounded-lg shadow-lg">
      <table id="paginatedTable" class="min-w-full w-full border-collapse">
        <thead class="text-center">
          <tr class="bg-gradient-to-br from-[#667eea] to-[#764ba2] text-white text-sm font-semibold uppercase tracking-wide">
            <th class="px-6 py-3" style="width: 50px; background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">
              <input type="checkbox" id="selectAllRequests" class="form-check-input" style="cursor: pointer; width: 18px; height: 18px;">
            </th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">First Name</th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">Email</th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">Phone Number</th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">Plan Name</th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">Amount (PKR) - Converted</th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">Transaction ID</th>
            <th class="px-6 py-3" style="  background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">Actions</th>
          </tr>
        </thead>

        <tbody class="bg-white">
          <% users.forEach(user => { %>
            <tr class="search-items text-center align-middle hover:bg-gray-50 transition-transform duration-200">
              <td class="px-6 py-4">
                <input type="checkbox" class="request-row-checkbox form-check-input" data-id="<%= user.id %>" style="cursor: pointer; width: 18px; height: 18px;">
              </td>
              <td class="px-6 py-4 text-left font-semibold text-gray-800">
                <i class="bi bi-person-circle text-primary me-2"></i>
                <%= user.first_name %> <%= user.last_name %>
              </td>

              <td class="px-6 py-4">
                <div class="d-flex align-items-center justify-content-center">
                  <div class="bg-light rounded-3 px-3 py-2 border border-primary border-opacity-25">
                    <i class="bi bi-envelope-fill text-primary me-2"></i>
                    <span class="text-dark fw-medium" style="font-size: 0.9rem;"><%= user.email %></span>
                  </div>
                </div>
              </td>

              <td class="px-6 py-4 text-gray-600">
                <i class="bi bi-telephone text-success me-2"></i>
                <%= user.phone_number %>
              </td>

              <td class="px-6 py-4">
                <div class="d-flex justify-content-center">
                  <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.9rem; padding: 8px 16px;">
                    <%= user.plan_name %>
                  </span>
                </div>
              </td>

              <td class="px-6 py-4">
                <div class="d-flex justify-content-center">
                  <span class="amount-value">
                    ₨<%= user.displayAmount || (parseFloat(user.amount) * 397.1863).toFixed(2) %>
                  </span>
                </div>
              </td>

              <td class="px-6 py-4">
                <div class="d-flex justify-content-center">
                  <span class="transaction-id">
                    <i class="bi bi-credit-card me-2"></i><%= user.transfer_id %>
                  </span>
                </div>
              </td>

              <td class="px-6 py-4">
                <div class="flex flex-wrap justify-center gap-2">
                  <button class="btn btn-success btn-sm px-3 rounded-pill shadow-sm accept-btn d-flex align-items-center" data-user-id="<%= user.id %>">
                    <i class="bi bi-check-circle me-1"></i> Accept
                  </button>
                  <button class="btn btn-danger btn-sm px-3 rounded-pill shadow-sm deny-btn d-flex align-items-center" data-user-id="<%= user.id %>">
                    <i class="bi bi-x-circle me-1"></i> Deny
                  </button>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CARDS: visible at width < 1200px -->
  <div class="min-[1200px]:hidden block">
    <% users.forEach(user => { %>
      <article class="w-full bg-white rounded-lg border border-gray-100 shadow-sm p-2 break-words mb-3">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
              <i class="bi bi-person-circle text-3xl text-indigo-600"></i>
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold text-gray-800 truncate"><%= user.first_name %> <%= user.last_name %></div>
              <div class="mt-2 bg-light rounded-2 px-2 py-1 border border-primary border-opacity-25">
                <i class="bi bi-envelope-fill text-primary" style="font-size: 0.75rem;"></i>
                <span class="text-dark ms-1" style="font-size: 0.75rem; font-weight: 500;"><%= user.email %></span>
              </div>
              <div class="text-xs text-gray-500 mt-2"><i class="bi bi-telephone me-1"></i><%= user.phone_number %></div>
              <div class="mt-2">
                <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 4px 10px;">
                  <%= user.plan_name %>
                </span>
              </div>
              <div class="mt-2">
                <span class="text-white px-2 py-1 rounded-pill shadow-sm" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); font-size: 0.75rem; font-weight: 600; display: inline-block;">
                  ₨<%= user.displayAmount || (parseFloat(user.amount) * 397.1863).toFixed(2) %>
                </span>
              </div>
              <div class="mt-2">
                <span class="text-white px-2 py-1 rounded-pill shadow-sm" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-size: 0.7rem; font-weight: 600; display: inline-block;">
                  <i class="bi bi-credit-card me-1"></i><%= user.transfer_id %>
                </span>
              </div>
            </div>
          </div>

          <div class="flex-shrink-0 flex items-center mt-3 sm:mt-0">
            <div class="flex flex-wrap gap-2 justify-center">
              <button class="btn btn-success btn-sm px-3 rounded-pill shadow-sm accept-btn d-flex align-items-center" data-user-id="<%= user.id %>">
                <i class="bi bi-check-circle me-1"></i> Accept
              </button>
              <button class="btn btn-danger btn-sm px-3 rounded-pill shadow-sm deny-btn d-flex align-items-center" data-user-id="<%= user.id %>">
                <i class="bi bi-x-circle me-1"></i> Deny
              </button>
            </div>
          </div>
        </div>
      </article>
    <% }); %>
  </div>

</div>

          </div>
      </div>
<!-- Delete Selected Button -->
<div class="mb-4">
  <button id="deleteSelectedBtn"
          data-table="requests"
          class="btn btn-danger shadow-sm px-4 py-2 fw-semibold"
          style="display: none;">
    <i class="fas fa-trash-alt me-2"></i> Delete Selected
  </button>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-4 px-3">
  <span id="tableInfo" class="text-muted">Showing <span id="currentEntries">0</span> entries</span>
  <nav>
    <ul class="pagination mb-0" id="pagination"></ul>
  </nav>
</div>

       </div>
   </div>
   <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Template Javascript -->
<script src="js/main.js"></script>

<script>
  // Pagination
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      const rowsPerPage = 10;
      let currentPage = 1;
      const tableRows = document.querySelectorAll('#paginatedTable tbody tr');
      const cardRows = document.querySelectorAll('.min-\[1200px\]\:hidden article');
      const totalRows = tableRows.length > 0 ? tableRows.length : cardRows.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage);

      function showPage(page) {
        currentPage = page;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        tableRows.forEach((row, index) => {
          row.style.display = (index >= start && index < end) ? '' : 'none';
        });

        cardRows.forEach((card, index) => {
          card.style.display = (index >= start && index < end) ? '' : 'none';
        });

        document.getElementById('currentEntries').textContent = Math.min(end, totalRows);
        updatePagination();
      }

      function updatePagination() {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;
        pagination.innerHTML = '';

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#"><i class="bi bi-chevron-left me-1"></i> Previous</a>`;
        prevLi.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentPage > 1) showPage(currentPage - 1);
        });
        pagination.appendChild(prevLi);

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#">Next <i class="bi bi-chevron-right ms-1"></i></a>`;
        nextLi.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentPage < totalPages) showPage(currentPage + 1);
        });
        pagination.appendChild(nextLi);
      }

      if (totalRows > 0) showPage(1);
    }, 100);
  });

  // Notification logic for Accept/Deny buttons
  document.querySelectorAll(".accept-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const userId = btn.getAttribute("data-user-id");
      try {
        const res = await fetch(`/admin/notify/manual-payment/${userId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: "Your payment has been verified. Please wait, your plan will activate within 1–2 hours."
          })
        });
        const data = await res.json();
        if (data.success) {
          alert("Notification sent successfully! Now go to Plan Request page to activate the plan.");
          setTimeout(() => window.location.href = '/package-request', 1500);
        } else {
          alert("Failed to send notification.");
        }
      } catch (err) {
        console.error(err);
        alert("Error sending notification.");
      }
    });
  });

  document.querySelectorAll(".deny-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const userId = btn.getAttribute("data-user-id");
      try {
        const res = await fetch(`/admin/notify/manual-payment/${userId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: "Your transaction has an issue and payment was not received. Please contact support."
          })
        });
        const data = await res.json();
        if (data.success) {
          alert("Denial notification sent successfully!");
          setTimeout(() => location.reload(), 1000);
        } else {
          alert("Failed to send notification.");
        }
      } catch (err) {
        console.error(err);
        alert("Error sending notification.");
      }
    });
  });

  // Delete Selected Requests functionality
  document.addEventListener("DOMContentLoaded", () => {
    const selectAll = document.getElementById("selectAllRequests");
    const checkboxes = document.querySelectorAll(".request-row-checkbox");
    const deleteBtn = document.getElementById("deleteSelectedBtn");

    const toggleButton = () => {
      const selected = document.querySelectorAll(".request-row-checkbox:checked").length;
      deleteBtn.style.display = selected > 0 ? "inline-flex" : "none";
    };

    if (selectAll) {
      selectAll.addEventListener("change", () => {
        checkboxes.forEach(cb => {
          if (cb.closest('tr').style.display !== 'none') {
            cb.checked = selectAll.checked;
          }
        });
        toggleButton();
      });
    }

    checkboxes.forEach(cb => cb.addEventListener("change", () => {
      const visibleCheckboxes = Array.from(checkboxes).filter(checkbox =>
        checkbox.closest('tr').style.display !== 'none'
      );
      const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
      if (selectAll) selectAll.checked = allChecked;
      toggleButton();
    }));

    deleteBtn.addEventListener("click", async () => {
      const selectedIds = [...document.querySelectorAll(".request-row-checkbox:checked")].map(cb => cb.dataset.id);
      if (selectedIds.length === 0) return alert("Please select at least one request to delete.");
      if (!confirm(`Delete ${selectedIds.length} selected request(s)?`)) return;

      try {
        const tableName = deleteBtn.dataset.table; // "requests"
        const res = await fetch(`/delete-selected/${tableName}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ selectedIds }),
        });

        const data = await res.json();
        if (data.success) {
          selectedIds.forEach(id => {
            const row = document.querySelector(`tr[data-user-id="${id}"]`);
            if (row) row.remove();
          });
          alert("Selected requests deleted successfully.");
          toggleButton();
        } else {
          alert("Error deleting requests: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("Something went wrong.");
      }
    });

    toggleButton();
  });
</script>
<!-- footer -->
  <%- include('../par/footer.ejs') %>
  <!-- footer -->
  
</body>
<!-- JavaScript Libraries -->


</html>
