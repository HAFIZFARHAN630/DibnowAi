<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Tickets - DIB-NOW</title>

    <link rel="icon" href="\images\DIB-NOW-512.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />
    <link href="bootstrap.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link href="styles1.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      .fade-in-up { animation: fadeInUp 0.6s ease-out; }
      .slide-in { animation: slideIn 0.6s ease-out; }
      .glass-morphism { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
      .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
      .status-open { background: linear-gradient(135deg, #10b981, #059669); }
      .status-progress { background: linear-gradient(135deg, #f59e0b, #d97706); }
      .status-closed { background: linear-gradient(135deg, #6b7280, #4b5563); }
      .priority-high { background: linear-gradient(135deg, #ef4444, #dc2626); }
      .priority-medium { background: linear-gradient(135deg, #f59e0b, #d97706); }
      .priority-low { background: linear-gradient(135deg, #10b981, #059669); }

      /* Table layout improvements */
      .table-container {
        width: 100%;
        overflow-x: auto;
      }

      .table-container table {
        min-width: 100%;
      }

      .table-container th,
      .table-container td {
        vertical-align: top;
        padding: 12px 24px;
      }

      /* Ensure proper width distribution */
      .table-container th:nth-child(1),
      .table-container td:nth-child(1) { width: 16.66%; }

      .table-container th:nth-child(2),
      .table-container td:nth-child(2) { width: 33.33%; }

      .table-container th:nth-child(3),
      .table-container td:nth-child(3) { width: 16.66%; }

      .table-container th:nth-child(4),
      .table-container td:nth-child(4),
      .table-container th:nth-child(5),
      .table-container td:nth-child(5) { width: 8.33%; }

      .table-container th:nth-child(6),
      .table-container td:nth-child(6) { width: 16.66%; }

      .table-container th:nth-child(7),
      .table-container td:nth-child(7),
      .table-container th:nth-child(8),
      .table-container td:nth-child(8) { width: 8.33%; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">

<%- include('../par/sidebar.ejs') %>
<%- include('../par/header.ejs') %>

<!-- Hero Section -->
<div class="relative overflow-hidden bg-gradient-to-r  mt-10" style="background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);">
  <div class="absolute inset-0 bg-black opacity-10"></div>
  <div class="relative w-full mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
      <div class="fade-in-up">
        <h1 class="text-3xl md:text-5xl font-bold text-white mb-4">
          <i class="fas fa-tickets-alt mr-4"></i>All Support Tickets
        </h1>
        <p class="text-lg md:text-xl text-slate-100">
          Manage and track all support requests in one place
        </p>
      </div>
      <div class="mt-6 lg:mt-0 fade-in-up" style="animation-delay: 0.2s;">
        <div class="flex flex-col sm:flex-row gap-3">
          <a href="/ticket" class="inline-flex items-center px-6 py-3  font-semibold rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300" style="background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%) !important; color: white;">
            <i class="fas fa-plus mr-3"></i>Create New Ticket
          </a>
          <button onclick="window.print()" class="inline-flex items-center px-6 py-3 bg-slate-500/80 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
            <i class="fas fa-print mr-3"></i>Print List
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<% if (tickets && tickets.length > 0) { %>
<div class="w-full mx-auto px-4 sm:px-6 lg:px-8 -mt-8 mb-8">
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 fade-in-up" style="animation-delay: 0.3s;">
    <div class="glass-morphism rounded-2xl p-6 border border-white/20 shadow-xl">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
          <i class="fas fa-play text-green-600 text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Open</p>
          <p class="text-2xl font-bold text-gray-900"><%= tickets.filter(t => t.status === 'Open').length %></p>
        </div>
      </div>
    </div>

    <div class="glass-morphism rounded-2xl p-6 border border-white/20 shadow-xl">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
          <i class="fas fa-clock text-amber-600 text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">In Progress</p>
          <p class="text-2xl font-bold text-gray-900"><%= tickets.filter(t => t.status === 'In-Progress').length %></p>
        </div>
      </div>
    </div>

    <div class="glass-morphism rounded-2xl p-6 border border-white/20 shadow-xl">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
          <i class="fas fa-check text-gray-600 text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Closed</p>
          <p class="text-2xl font-bold text-gray-900"><%= tickets.filter(t => t.status === 'Closed').length %></p>
        </div>
      </div>
    </div>

    <div class="glass-morphism rounded-2xl p-6 border border-white/20 shadow-xl">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
          <i class="fas fa-ticket-alt text-blue-600 text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-600">Total</p>
          <p class="text-2xl font-bold text-gray-900"><%= tickets.length %></p>
        </div>
      </div>
    </div>
  </div>
</div>
<% } %>

<!-- Tickets Table -->
<div class="w-full mx-auto px-4 sm:px-6 lg:px-8 pb-12">
  <% if (tickets && tickets.length > 0) { %>
    <div class="glass-morphism rounded-3xl shadow-2xl border border-white/20 overflow-hidden fade-in-up" style="animation-delay: 0.4s;">
      <div class="p-6 border-b border-gray-200">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">All Tickets</h2>
          <div class="flex items-center space-x-4">
            <div class="relative">
              <input type="text" id="searchInput" placeholder="Search tickets..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">All Status</option>
              <option value="Open">Open</option>
              <option value="In-Progress">In Progress</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Desktop Table View -->
      <div class="hidden lg:block table-container">
        <div class="inline-block min-w-full align-middle">
          <table class="w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-gray-50 to-slate-50">
            <tr style="background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%) !important;">
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="width: 50px;">
                <input type="checkbox" id="selectAllTickets" class="form-check-input" style="cursor: pointer; width: 18px; height: 18px;">
              </th>
              <th class="w-1/6 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-ticket-alt mr-2"></i>Ticket
              </th>
              <th class="w-2/6 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-heading mr-2"></i>Title
              </th>
              <th class="w-1/6 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-user mr-2"></i>Reporter
              </th>
              <th class="w-1/12 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-tag mr-2"></i>Category
              </th>
              <th class="w-1/12 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-exclamation-triangle mr-2"></i>Priority
              </th>
              <th class="w-1/6 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-calendar mr-2"></i>Created
              </th>
              <th class="w-1/12 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-info-circle mr-2"></i>Status
              </th>
              <th class="w-1/6 px-6 py-4 text-left text-xs font-bold  uppercase tracking-wider">
                <i class="fas fa-cogs mr-2"></i>Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% tickets.forEach((ticket, index) => { %>
              <tr class="hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-300 slide-in ticket-row">
                <td class="px-6 py-4">
                  <input type="checkbox" class="ticket-row-checkbox form-check-input" data-id="<%= ticket._id %>" style="cursor: pointer; width: 18px; height: 18px;">
                </td>
                <!-- Ticket ID & Description -->
                <td class="w-1/6 px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                      <i class="fas fa-ticket-alt text-white text-sm"></i>
                    </div>
                    <div>
                      <div class="text-sm font-bold text-gray-900">#<%= ticket.ticketId %></div>
                      <div class="text-xs text-gray-500 max-w-[150px] truncate" title="<%= ticket.description %>">
                        <%= ticket.description %>
                      </div>
                    </div>
                  </div>
                </td>

                <!-- Title -->
                <td class="w-2/6 px-6 py-4">
                  <div class="text-sm font-semibold text-gray-900 max-w-[300px]" title="<%= ticket.title %>">
                    <%= ticket.title %>
                  </div>
                </td>

                <!-- Reporter -->
                <td class="w-1/6 px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mr-3">
                      <i class="fas fa-user text-white text-xs"></i>
                    </div>
                    <div class="text-sm font-medium text-gray-900 max-w-[120px] truncate" title="<% if (ticket.user && (ticket.user.first_name || ticket.user.last_name)) { %><%= (ticket.user.first_name || '') + ' ' + (ticket.user.last_name || '') %><% } else { %><%= ticket.userId %><% } %>">
                      <% if (ticket.user && (ticket.user.first_name || ticket.user.last_name)) { %>
                        <%= (ticket.user.first_name || '') + ' ' + (ticket.user.last_name || '') %>
                      <% } else { %>
                        <%= ticket.userId %>
                      <% } %>
                    </div>
                  </div>
                </td>

                <!-- Category -->
                <td class="w-1/12 px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-800">
                    <i class="fas fa-tag mr-1"></i><%= ticket.category %>
                  </span>
                </td>

                <!-- Priority -->
                <td class="w-1/12 px-6 py-4 whitespace-nowrap">
                  <% if (ticket.priority === 'High') { %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold priority-high text-white shadow-lg">
                      <i class="fas fa-exclamation-triangle mr-1"></i>HIGH
                    </span>
                  <% } else if (ticket.priority === 'Medium') { %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold priority-medium text-white shadow-lg">
                      <i class="fas fa-exclamation-circle mr-1"></i>MEDIUM
                    </span>
                  <% } else { %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold priority-low text-white shadow-lg">
                      <i class="fas fa-check-circle mr-1"></i>LOW
                    </span>
                  <% } %>
                </td>

                <!-- Created Date -->
                <td class="w-1/6 px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900 font-semibold"><%= new Date(ticket.createdAt).toLocaleDateString() %></div>
                  <div class="text-xs text-gray-500"><%= new Date(ticket.createdAt).toLocaleTimeString() %></div>
                </td>

                <!-- Status -->
                <td class="w-1/12 px-6 py-4 whitespace-nowrap">
                  <% if (ticket.status === 'Open') { %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold status-open text-white shadow-lg">
                      <i class="fas fa-play mr-1"></i>Open
                    </span>
                  <% } else if (ticket.status === 'In-Progress') { %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold status-progress text-white shadow-lg">
                      <i class="fas fa-clock mr-1"></i>In-Progress
                    </span>
                  <% } else { %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold status-closed text-white shadow-lg">
                      <i class="fas fa-check mr-1"></i>Closed
                    </span>
                  <% } %>
                </td>

                <!-- Actions -->
                <td class="w-1/6 px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="flex items-center space-x-2">
                    <button onclick="window.location.href='/track-ticket?id=<%= ticket.ticketId %>'"
                            class="text-indigo-600 hover:text-indigo-900 font-semibold hover:bg-indigo-50 px-2 py-1 rounded transition-all duration-300">
                      <i class="fas fa-eye mr-1"></i>View
                    </button>
                    <select
                      id="status-<%= ticket._id %>"
                      class="px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500 bg-white"
                      onchange="window.location.href='/change-status-ticket?id=<%= ticket._id %>&status='+encodeURIComponent(this.value)"
                    >
                      <option value="Open" <%= ticket.status === 'Open' ? 'selected' : '' %>>Open</option>
                      <option value="In-Progress" <%= ticket.status === 'In-Progress' ? 'selected' : '' %>>In-Progress</option>
                      <option value="Closed" <%= ticket.status === 'Closed' ? 'selected' : '' %>>Closed</option>
                    </select>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
          </table>
        </div>
      </div>

<!-- Delete Selected Button -->
<div class="mb-4">
  <button id="deleteSelectedBtn"
          data-table="tickets"
          class="btn btn-danger shadow-sm px-4 py-2 fw-semibold"
          style="display: none;">
    <i class="fas fa-trash-alt me-2"></i> Delete Selected
  </button>
</div>

      <!-- Mobile Card View -->
     <div class="lg:hidden space-y-4 p-6">
  <% tickets.forEach((ticket, index) => { %>
    <div class="bg-gradient-to-r from-white to-gray-50 rounded-2xl p-6 shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 slide-in">
      <div class="flex items-start md:justify-between flex-wrap gap-5 mb-4">
        <div class="flex items-center space-x-3 flex-wrap gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
            <i class="fas fa-ticket-alt text-white"></i>
          </div>
          <div>
            <h3 class="font-bold text-gray-900">#<%= ticket.ticketId %></h3>
            <p class="text-sm text-gray-600">Created <%= new Date(ticket.createdAt).toLocaleDateString() %></p>
          </div>
        </div>
        <% if (ticket.status === 'Open') { %>
          <span class="px-3 py-1 rounded-full text-xs font-bold status-open text-white">Open</span>
        <% } else if (ticket.status === 'In-Progress') { %>
          <span class="px-3 py-1 rounded-full text-xs font-bold status-progress text-white">In-Progress</span>
        <% } else { %>
          <span class="px-3 py-1 rounded-full text-xs font-bold status-closed text-white">Closed</span>
        <% } %>
      </div>

      <h4 class="font-semibold text-gray-900 mb-2"><%= ticket.title %></h4>
      <p class="text-sm text-gray-600 mb-4 line-clamp-2"><%= ticket.description %></p>

      <!-- STACKED ON SMALL SCREENS: prevents Priority overlapping Reporter -->
      <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Reporter</p>
          <p class="text-sm font-medium text-gray-900 truncate break-words">
            <% if (ticket.user && (ticket.user.first_name || ticket.user.last_name)) { %>
              <%= (ticket.user.first_name || '') + ' ' + (ticket.user.last_name || '') %>
            <% } else { %>
              <%= ticket.userId %>
            <% } %>
          </p>
        </div>
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Priority</p>
          <% if (ticket.priority === 'High') { %>
            <span class="inline-block text-xs font-bold priority-high text-white px-2 py-1 rounded">HIGH</span>
          <% } else if (ticket.priority === 'Medium') { %>
            <span class="inline-block text-xs font-bold priority-medium text-white px-2 py-1 rounded">MEDIUM</span>
          <% } else { %>
            <span class="inline-block text-xs font-bold priority-low text-white px-2 py-1 rounded">LOW</span>
          <% } %>
        </div>
      </div>

      <!-- make tag + actions stack vertically on small screens, row on larger -->
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-3 sm:space-y-0">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-800">
          <i class="fas fa-tag mr-1"></i><%= ticket.category %>
        </span>

        <div class="flex items-center space-x-2 w-full sm:w-auto justify-end">
          <button onclick="window.location.href='/track-ticket?id=<%= ticket.ticketId %>'"
                  class="text-indigo-600 hover:text-indigo-900 font-semibold text-sm">
            <i class="fas fa-eye mr-1"></i>View
          </button>
          <select
            id="status-mobile-<%= ticket._id %>"
            class="text-xs px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500 w-full sm:w-auto max-w-xs"
            onchange="window.location.href='/change-status-ticket?id=<%= ticket._id %>&status='+encodeURIComponent(this.value)"
          >
            <option value="Open" <%= ticket.status === 'Open' ? 'selected' : '' %>>Open</option>
            <option value="In-Progress" <%= ticket.status === 'In-Progress' ? 'selected' : '' %>>In-Progress</option>
            <option value="Closed" <%= ticket.status === 'Closed' ? 'selected' : '' %>>Closed</option>
          </select>
        </div>
      </div>
    </div>
  <% }) %>
</div>

    </div>
  <% } else { %>
    <!-- Empty State -->
    <div class="glass-morphism rounded-3xl shadow-2xl p-16 border border-white/20 text-center">
      <div class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-ticket-alt text-4xl text-gray-400"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">No Tickets Found</h3>
      <p class="text-gray-600 mb-8 max-w-md mx-auto">There are no support tickets to display at the moment. Create your first ticket to get started!</p>
      <a href="/create-ticket" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
        <i class="fas fa-plus mr-3"></i>Create Your First Ticket
      </a>
    </div>
  <% } %>
</div>



        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
        <script src="js/main.js"></script>

        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const selectAll = document.getElementById("selectAllTickets");
            const checkboxes = document.querySelectorAll(".ticket-row-checkbox");
            const deleteBtn = document.getElementById("deleteSelectedBtn");

            const toggleButton = () => {
              const selected = document.querySelectorAll(".ticket-row-checkbox:checked").length;
              deleteBtn.style.display = selected > 0 ? "inline-flex" : "none";
            };

            if (selectAll) {
              selectAll.addEventListener("change", () => {
                checkboxes.forEach(cb => {
                  if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = selectAll.checked;
                  }
                });
                toggleButton();
              });
            }

            checkboxes.forEach(cb => cb.addEventListener("change", () => {
              const visibleCheckboxes = Array.from(checkboxes).filter(checkbox =>
                checkbox.closest('tr').style.display !== 'none'
              );
              const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
              if (selectAll) selectAll.checked = allChecked;
              toggleButton();
            }));

            deleteBtn.addEventListener("click", async () => {
              const selectedIds = [...document.querySelectorAll(".ticket-row-checkbox:checked")].map(cb => cb.dataset.id);
              if (selectedIds.length === 0) return alert("Please select at least one ticket to delete.");
              if (!confirm(`Delete ${selectedIds.length} selected ticket(s)?`)) return;

              try {
                const tableName = deleteBtn.dataset.table; // "tickets"
                const res = await fetch(`/delete-selected/${tableName}`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ selectedIds }),
                });

                const data = await res.json();
                if (data.success) {
                  selectedIds.forEach(id => {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) row.remove();
                  });
                  alert("Selected tickets deleted successfully.");
                  toggleButton();
                } else {
                  alert("Error deleting tickets: " + data.message);
                }
              } catch (err) {
                console.error(err);
                alert("Something went wrong.");
              }
            });

            toggleButton();
          });

          // Search and Filter Functionality
          document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const tableRows = document.querySelectorAll('tbody tr');
            const cards = document.querySelectorAll('.lg\\:hidden .bg-gradient-to-r');

            function filterTickets() {
              const searchTerm = searchInput.value.toLowerCase();
              const selectedStatus = statusFilter.value.toLowerCase();

              // Filter table rows (desktop)
              tableRows.forEach(row => {
                const ticketId = row.querySelector('td:first-child .font-mono')?.textContent.toLowerCase() || '';
                const title = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                const reporter = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                const category = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
                const priority = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                const status = row.querySelector('td:nth-child(7) span')?.textContent.toLowerCase() || '';

                const matchesSearch = ticketId.includes(searchTerm) || title.includes(searchTerm) ||
                                    reporter.includes(searchTerm) || category.includes(searchTerm) ||
                                    priority.includes(searchTerm);

                const matchesStatus = !selectedStatus || status.includes(selectedStatus);

                if (matchesSearch && matchesStatus) {
                  row.style.display = '';
                } else {
                  row.style.display = 'none';
                }
              });

              // Filter cards (mobile)
              cards.forEach(card => {
                const ticketId = card.querySelector('h3')?.textContent.toLowerCase() || '';
                const title = card.querySelector('h4')?.textContent.toLowerCase() || '';
                const description = card.querySelector('p')?.textContent.toLowerCase() || '';
                const reporter = card.querySelector('div > p:last-child')?.textContent.toLowerCase() || '';
                const status = card.querySelector('span[class*="status-"]')?.textContent.toLowerCase() || '';

                const matchesSearch = ticketId.includes(searchTerm) || title.includes(searchTerm) ||
                                    description.includes(searchTerm) || reporter.includes(searchTerm);

                const matchesStatus = !selectedStatus || status.includes(selectedStatus);

                if (matchesSearch && matchesStatus) {
                  card.style.display = '';
                } else {
                  card.style.display = 'none';
                }
              });
            }

            // Add event listeners
            if (searchInput) searchInput.addEventListener('input', filterTickets);
            if (statusFilter) statusFilter.addEventListener('change', filterTickets);

            // Status change feedback
            function showFeedback(message, isSuccess = true) {
              const feedback = document.createElement('div');
              feedback.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 ${
                isSuccess ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
              }`;
              feedback.textContent = message;
              document.body.appendChild(feedback);

              setTimeout(() => {
                feedback.remove();
              }, 3000);
            }

            // Enhanced status change handler
            document.querySelectorAll('select[id^="status"]').forEach(select => {
              select.addEventListener('change', function() {
                const originalValue = this.dataset.originalValue || this.value;
                showFeedback('Updating ticket status...', true);

                // Add loading state
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = '<option>Loading...</option>';

                // Simulate network request (replace with actual API call)
                setTimeout(() => {
                  this.disabled = false;
                  this.innerHTML = originalText;
                  this.value = this.value; // Keep new value
                  showFeedback('Status updated successfully!', true);
                }, 1000);
              });
            });
          });

          // Smooth scrolling for better UX
          document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
              e.preventDefault();
              const target = document.querySelector(this.getAttribute('href'));
              if (target) {
                target.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              }
            });
          });

          // Add loading animation to status changes
          function handleStatusChange(ticketId, newStatus) {
            const select = document.getElementById(`status-${ticketId}`);
            if (select) {
              select.disabled = true;
              select.style.opacity = '0.5';

              // Simulate API call
              setTimeout(() => {
                select.disabled = false;
                select.style.opacity = '1';
              }, 1000);
            }
          }
        </script>
        <!-- footer -->
  <%- include('../par/footer.ejs') %>
  <!-- footer -->
</body>
</html>