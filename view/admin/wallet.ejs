<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="utf-8">
     <title>Wallet Management</title>
     <meta content="width=device-width, initial-scale=1.0" name="viewport">
     <meta content="" name="keywords">
     <meta content="" name="description">

     <!-- Favicon -->
     <link rel="icon" href="public\images\DIB-NOW-512.png" type="image/x-icon">

     <!-- Icon Font Stylesheet -->
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
     <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

     <!-- Customized Bootstrap Stylesheet -->
     <link href="/bootstrap.css" rel="stylesheet">
     <!-- Template Stylesheet -->
     <link href="/styles.css" rel="stylesheet">
     <link href="/styles1.css" rel="stylesheet">
     <script src="https://cdn.tailwindcss.com"></script>

     <style>
         .body-wrapper {
             min-height: 100%;
             display: flex;
             flex-direction: column;
         }

         .btn-gradient {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             border: 2px solid rgba(16, 185, 129, 0.3);
             border-radius: 15px;
             color: white;
             font-weight: 700;
             padding: 12px 25px;
             transition: all 0.3s ease;
             box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
             text-transform: uppercase;
             letter-spacing: 1px;
         }

         .btn-gradient:hover {
             background: linear-gradient(135deg, #059669 0%, #047857 100%);
             transform: translateY(-3px);
             box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3);
             color: white;
         }

         /* Summary Cards */
         .summary-card {
             background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
             border-radius: 15px;
             padding: 2rem;
             margin-bottom: 1.5rem;
             text-align: center;
             border: 2px solid rgba(255, 255, 255, 0.8);
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
             transition: all 0.3s ease;
         }

         .summary-card:hover {
             transform: translateY(-5px);
             box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
         }

         .summary-card h5 {
             color: #64748b;
             font-size: 14px;
             font-weight: 600;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             margin-bottom: 10px;
         }

         .summary-card h3 {
             color: #1e293b;
             font-size: 28px;
             font-weight: 700;
             margin: 0;
         }

         /* Search functionality */
         #walletSearch {
             border-radius: 25px;
             background-color: #f8f9fa;
             border: 2px solid #e9ecef;
             color: #212529;
             padding: 10px 20px;
             font-size: 14px;
             transition: all 0.3s ease;
         }

         #walletSearch:focus {
             background-color: #ffffff;
             border-color: #10b981;
             box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
             color: #212529;
         }

         #walletSearch::placeholder {
             color: #6c757d;
         }

         .search-container {
             position: relative;
             margin-bottom: 20px;
         }

         .search-icon {
             position: absolute;
             left: 15px;
             top: 50%;
             transform: translateY(-50%);
             color: #6c757d;
             z-index: 10;
         }

         .search-input-wrapper {
             position: relative;
         }

         .search-input-wrapper input {
             padding-left: 45px;
         }

         /* Enhanced Table Design */
         .table {
             border-radius: 15px;
             overflow: hidden;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
             border: none;
         }

         .table thead th {
             background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);
             color: white;
             font-weight: 600;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             border: none;
             padding: 20px 15px;
             font-size: 14px;
         }

         .table tbody tr {
             transition: all 0.3s ease;
             border: none;
         }

         .table tbody tr:hover {
             background-color: #f8f9ff;
             transform: translateY(-2px);
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
         }

         .table tbody td {
             padding: 18px 15px;
             border: none;
             border-bottom: 1px solid #f0f0f0;
             vertical-align: middle;
         }

         /* Plan Badges */
         .plan-badge {
             padding: 8px 16px;
             border-radius: 20px;
             font-weight: 600;
             font-size: 12px;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             display: inline-block;
             text-align: center;
             min-width: 100px;
         }

         .plan-free-trial {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             color: white;
             box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
         }

         .plan-basic {
             background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
             color: white;
             box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
         }

         .plan-standard {
             background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
             color: white;
             box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
         }

         .plan-premium {
             background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
             color: white;
             box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
         }

         .plan-default {
             background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
             color: white;
             box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
         }

         /* Balance and Quota Badges */
         .balance-badge {
             padding: 6px 12px;
             border-radius: 15px;
             font-weight: 600;
             font-size: 14px;
         }

         .balance-positive {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             color: white;
         }

         .balance-low {
             background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
             color: white;
         }

         .balance-negative {
             background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
             color: white;
         }

         .quota-badge {
             padding: 6px 12px;
             border-radius: 15px;
             font-weight: 600;
             font-size: 12px;
         }

         .quota-available {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             color: white;
         }

         .quota-exhausted {
             background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
             color: white;
         }

         /* User Info Styling */
         .user-name {
             font-weight: 600;
             color: #1f2937;
             margin-bottom: 2px;
         }

         .user-email {
             color: #6b7280;
             font-size: 13px;
         }

         /* Button Styling */
         .btn-action {
             border-radius: 8px;
             font-weight: 600;
             padding: 8px 16px;
             transition: all 0.3s ease;
         }

         .btn-action:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
         }

         .table tbody tr.search-hidden {
             display: none;
         }

         .no-results {
             text-align: center;
             padding: 40px;
             color: #6b7280;
         }

         .no-results i {
             font-size: 48px;
             margin-bottom: 15px;
             opacity: 0.5;
         }

         /* Responsive Design */
         @media (max-width: 768px) {
             .summary-card {
                 margin-bottom: 1rem;
                 padding: 1.5rem;
             }

             .summary-card h3 {
                 font-size: 24px;
             }

             .table-responsive {
                 font-size: 14px;
             }
             .res-flex{
              flex-direction: column;
             }
         }
         .res-flex{
          display: flex;
          align-items: center;
          justify-content: space-between;
         }

         /* Professional Pagination Buttons */
         .pagination .page-link {
           background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%) !important;
           color: white !important;
           border: none !important;
           font-weight: 600 !important;
           padding: 10px 24px !important;
           min-width: 120px !important;
           border-radius: 8px !important;
           transition: all 0.3s ease !important;
           box-shadow: 0 2px 8px rgba(0, 51, 204, 0.3) !important;
           display: inline-flex !important;
           align-items: center !important;
           justify-content: center !important;
         }

         .pagination .page-link:hover {
           transform: translateY(-2px) !important;
           box-shadow: 0 4px 12px rgba(0, 51, 204, 0.4) !important;
         }

         .pagination .page-item.disabled .page-link {
           background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%) !important;
           opacity: 0.6 !important;
           cursor: not-allowed !important;
         }

         .pagination .page-item {
           margin: 0 4px !important;
         }
     </style>
<body>
    <%- include('../par/sidebar.ejs') %>

    <!-- Navbar Start -->
    <%- include('../par/header.ejs') %>
    <!-- Navbar End -->

    <div class="body-wrapper" style="position: relative;">
        <div class="container-fluid">
            <div class="card card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="res-flex">
                            <h4 class="mb-4 mb-sm-0 card-title">Wallet Management <i class="bi bi-wallet2"></i></h4>
                            <a href="/admin" class="btn btn-gradient">Back to Dashboard</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flash Messages -->
            <% if (typeof success_msg !== 'undefined' && success_msg.lenght>0) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <%= success_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            <% if (typeof error_msg !== 'undefined' && error_msg.lenght>0) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5><i class="bi bi-people me-2"></i>Total Users</h5>
                        <h3><%= totalWallets %></h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5><i class="bi bi-cash-coin me-2"></i>Total Balance</h5>
                        <h3>£<%= totalBalance.toFixed(2) %></h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5><i class="bi bi-exclamation-triangle me-2"></i>Low Balance</h5>
                        <h3><%= lowBalanceUsers %></h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5><i class="bi bi-receipt me-2"></i>Transactions</h5>
                        <h3><%= totalTransactions %></h3>
                    </div>
                </div>
            </div>

            <!-- Wallet Users Table -->
            <div class="card card-body">
                 <div class="w-full mb-4">
    <label for="walletSearch" class="sr-only">Search users</label>

    <!-- flex container keeps icon vertically centered with input -->
    <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
      <i class="bi bi-search text-gray-400 text-lg"></i>

      <input
        id="walletSearch"
        type="text"
        class="flex-1 bg-transparent text-sm placeholder-gray-500 outline-none"
        placeholder="Search users by name, email, plan..."
      />
    </div>
  </div>


               <!-- TABLE: visible on small/medium, hidden on large+ -->
<!-- CARDS: visible at width < 1200px (cards full-width, fixed-height buttons) -->
<div class=" block">
  <!-- single-column so cards are always full width -->
  <div class="flex flex-col gap-4">
    <% if (usersWithWallets && usersWithWallets.length > 0) { %>
      <% usersWithWallets.forEach(user => { %>
        <div class="w-full bg-white rounded-lg border border-gray-100 shadow-sm p-4 flex flex-col">
          <!-- Header: user -->
          <div class="flex items-start gap-3">
            <i class="bi bi-person-circle text-3xl text-indigo-600 flex-shrink-0"></i>
            <div class="min-w-0">
              <div class="fw-bold text-sm font-semibold text-gray-800 truncate"><%= user.first_name %> <%= user.last_name %></div>
              <div class="text-xs text-gray-500 truncate"><%= user.email %></div>
            </div>
          </div>

          <!-- Plan & Balance -->
          <div class="flex flex-wrap items-center gap-2 mt-3">
            <% let planClass = 'plan-default'; %>
            <% if (user.plan_name && user.plan_name.toLowerCase().includes('free')) { %>
              <% planClass = 'plan-free-trial'; %>
            <% } else if (user.plan_name && user.plan_name.toLowerCase().includes('basic')) { %>
              <% planClass = 'plan-basic'; %>
            <% } else if (user.plan_name && user.plan_name.toLowerCase().includes('standard')) { %>
              <% planClass = 'plan-standard'; %>
            <% } else if (user.plan_name && user.plan_name.toLowerCase().includes('premium')) { %>
              <% planClass = 'plan-premium'; %>
            <% } %>
            <span class="plan-badge <%= planClass %> inline-flex items-center px-3 py-1 rounded-full text-xs">
              <i class="bi bi-credit-card me-1"></i><%= user.plan_name || 'No Plan' %>
            </span>

            <% let balanceClass = 'balance-positive'; %>
            <% if (user.balance < 10) { %>
              <% balanceClass = 'balance-low'; %>
            <% } else if (user.balance < 0) { %>
              <% balanceClass = 'balance-negative'; %>
            <% } %>
            <span class="balance-badge <%= balanceClass %> inline-flex items-center px-3 py-1 rounded-full text-xs">
              <i class="bi bi-cash-coin me-1"></i>£<%= user.balance.toFixed(2) %>
            </span>
          </div>

          <!-- Quota info -->
          <div class="mt-3 grid grid-cols-3 gap-2 text-center text-sm">
            <div>
              <div class="text-xs text-gray-500">Quota Limit</div>
              <div class="mt-1 inline-block px-2 py-1 rounded text-sm bg-gray-50 border"><%= user.plan_limit || 0 %></div>
            </div>
            <div>
              <div class="text-xs text-gray-500">Used</div>
              <div class="mt-1 inline-block px-2 py-1 rounded text-sm bg-blue-50 border"><%= user.quota_used || 0 %></div>
            </div>
            <div>
              <div class="text-xs text-gray-500">Remaining</div>
              <% let quotaClass = 'quota-available'; %>
              <% if ((user.plan_limit - user.quota_used) <= 0) { %>
                <% quotaClass = 'quota-exhausted'; %>
              <% } %>
              <div class="mt-1 inline-block px-2 py-1 rounded text-sm quota-badge <%= quotaClass %>"><%= user.plan_limit - user.quota_used %></div>
            </div>
          </div>

          <!-- Actions: fixed-height buttons to avoid height jump on tiny screens -->
          <div class="mt-4 flex gap-2">
            <a href="/admin/update/<%= user._id %>"
               class="btn btn-sm btn-primary btn-action flex-1 text-center h-9 flex items-center justify-center whitespace-nowrap text-sm min-w-0 overflow-hidden">
              <i class="bi bi-pencil me-1"></i>
              <span class="truncate">Edit</span>
            </a>

            <a href="/admin/wallet-transactions/<%= user._id %>"
               class="btn btn-sm btn-outline-info btn-action flex-1 text-center h-9 flex items-center justify-center whitespace-nowrap text-sm min-w-0 overflow-hidden">
              <i class="bi bi-eye me-1"></i>
              <span class="truncate">Transactions</span>
            </a>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <div class="col-span-1">
        <div class="w-full bg-white rounded-lg border border-gray-100 p-6 text-center text-gray-500">
          <i class="bi bi-wallet2 text-3xl mb-2"></i>
          <h5 class="mt-2 text-lg font-medium">No Wallet Users</h5>
          <p class="text-sm text-gray-500">Users with wallet balances will appear here.</p>
        </div>
      </div>
    <% } %>
  </div>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-4 px-3">
  <span id="tableInfo" class="text-muted">Showing <span id="currentEntries">0</span> entries</span>
  <nav>
    <ul class="pagination mb-0" id="pagination"></ul>
  </nav>
</div>

            </div>
        </div>
    </div>

    <%- include('../par/footer.ejs') %>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Template Javascript -->
    <script src="/js/main.js"></script>

    <script>
        // Wallet Search Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Pagination
            setTimeout(function() {
                const rowsPerPage = 10;
                let currentPage = 1;
                const cardRows = document.querySelectorAll('.flex.flex-col.gap-4 > div');
                const totalRows = cardRows.length;
                const totalPages = Math.ceil(totalRows / rowsPerPage);

                function showPage(page) {
                    currentPage = page;
                    const start = (page - 1) * rowsPerPage;
                    const end = start + rowsPerPage;

                    cardRows.forEach((card, index) => {
                        card.style.display = (index >= start && index < end) ? '' : 'none';
                    });

                    document.getElementById('currentEntries').textContent = Math.min(end, totalRows);
                    updatePagination();
                }

                function updatePagination() {
                    const pagination = document.getElementById('pagination');
                    if (!pagination) return;
                    pagination.innerHTML = '';

                    const prevLi = document.createElement('li');
                    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                    prevLi.innerHTML = `<a class="page-link" href="#"><i class="bi bi-chevron-left me-1"></i> Previous</a>`;
                    prevLi.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (currentPage > 1) showPage(currentPage - 1);
                    });
                    pagination.appendChild(prevLi);

                    const nextLi = document.createElement('li');
                    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                    nextLi.innerHTML = `<a class="page-link" href="#">Next <i class="bi bi-chevron-right ms-1"></i></a>`;
                    nextLi.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (currentPage < totalPages) showPage(currentPage + 1);
                    });
                    pagination.appendChild(nextLi);
                }

                if (totalRows > 0) showPage(1);
            }, 100);

            const searchInput = document.getElementById('walletSearch');
            const table = document.getElementById('walletUsersTable');

            if (searchInput && table) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    const rows = table.querySelectorAll('tbody tr');
                    let visibleRows = 0;

                    rows.forEach(row => {
                        // Skip the "No wallet users" row
                        if (row.cells.length === 1 && row.cells[0].getAttribute('colspan') === '7') {
                            return;
                        }

                        const name = row.cells[0].textContent.toLowerCase();
                        const email = row.cells[0].textContent.toLowerCase();
                        const plan = row.cells[1].textContent.toLowerCase();

                        // Check if search term matches any of the fields
                        const matches = name.includes(searchTerm) ||
                                      email.includes(searchTerm) ||
                                      plan.includes(searchTerm);

                        if (matches) {
                            row.style.display = '';
                            row.classList.remove('search-hidden');
                            visibleRows++;
                        } else {
                            row.style.display = 'none';
                            row.classList.add('search-hidden');
                        }
                    });

                    // Show/hide "No results" message
                    updateNoResultsMessage(visibleRows);
                });
            }

            function updateNoResultsMessage(visibleRows) {
                // Remove existing "No results" message
                const existingNoResults = table.querySelector('.no-results-row');
                if (existingNoResults) {
                    existingNoResults.remove();
                }

                // If no rows are visible and there's a search term, show "No results" message
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (visibleRows === 0 && searchTerm !== '') {
                    const tbody = table.querySelector('tbody');
                    const noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = `
                        <td colspan="7" class="text-center">
                            <div class="no-results">
                                <i class="bi bi-search"></i>
                                <h5 class="mt-3 text-muted">No matching users found</h5>
                                <p class="text-muted">Try adjusting your search terms or clearing the search box</p>
                                <button class="btn btn-outline-primary btn-sm mt-2" onclick="document.getElementById('walletSearch').value=''">
                                    <i class="bi bi-x-circle me-1"></i>Clear Search
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(noResultsRow);
                }
            }

            // Clear search when input is empty
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Escape' || this.value === '') {
                    this.value = '';
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        row.style.display = '';
                        row.classList.remove('search-hidden');
                    });
                    updateNoResultsMessage(rows.length);
                }
            });
        });
    </script>
</body>
</html>