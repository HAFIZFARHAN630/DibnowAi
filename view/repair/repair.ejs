<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Repair Status</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

        <!-- Favicon -->
            <link rel="icon" href="\images\DIB-NOW-512.png" type="image/x-icon">

    
    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Customized Bootstrap Stylesheet -->
    <link href="bootstrap.css" rel="stylesheet">
    <!-- Template Stylesheet -->
    <link href="styles.css" rel="stylesheet">
    <link href="styles1.css" rel="stylesheet">
    <style>

      .body-wrapper {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .footer {
          margin-top: auto;
          padding: 5px 80px 5px 30px;
          background-color: #dadae0;
          text-align: center;
          width: 109%;
          margin-left: -35px;
            }
      </style>
</head>
<body>

  <!--  -->
  <%- include('../par/Add_Repair.ejs') %>
  <!--  -->

               <%- include('../par/sidebar.ejs') %>

  <!-- Navbar Start -->
  <%- include('../par/header.ejs') %>


  <% if (success_msg.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong><i class="icon fa fa-check-circle me-2"></i><%= success_msg %></strong> 
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>
<% if (error_msg.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><%= error_msg %></strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>

<div  class="action-buttons" style="display:flex; justify-content: end; margin-top: 10px; gap: 5px; margin-right: 23px;">
  <button class="btn btn-action btn-danger" data-bs-toggle="modal" data-bs-target="#gadgetRepairModal"><i class="bi bi-tools"></i> Add Repair Customer </button> 
  <button class="btn btn-action btn-primary" data-bs-toggle="modal" data-bs-target="#gadgetrModal"><i class="bi bi-clipboard-data"></i> Add Inventory</button>
</div>
    <!-- Navbar End -->


<!-- graph -->
<div class="container-fluid pt-4 px-4">
  <div class="row g-4">
    <!-- Chart Container -->
    <div class="col-12 col-md-12">
      <div class="h-100 p-4" style="border-radius: 15px; background-color: #fff; max-width: 100%; width: 100%;">
        <!-- Overview Content -->
        <h6 class="text-dark mb-3">Monthly Earnings</h6>
        <div style="position: relative; height: 300px;">
          <canvas id="earningsChart"></canvas>
        </div>
      </div>
    </div>
<!-- Script for Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('earningsChart').getContext('2d');

// Function to fetch repair prices from the backend
async function fetchRepairPrices() {
  try {
    const response = await fetch('/api/repair-prices');
    if (!response.ok) throw new Error("Failed to fetch repair prices");
    const prices = await response.json();
    return prices;
  } catch (error) {
    console.error("Error fetching repair prices:", error);
    return [];
  }
}

// Function to initialize the chart
async function initializeChart() {
  const prices = await fetchRepairPrices();

  const createGradient = (ctx, colorStart, colorEnd) => {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, colorStart);
    gradient.addColorStop(1, colorEnd);
    return gradient;
  };

  const gradientBlue = createGradient(ctx, 'rgba(0, 176, 255, 0.8)', 'rgba(0, 176, 255, 0)');

  const chartData = {
    labels: Array.from({ length: prices.length }, (_, i) => i + 1), // Generate labels for each price
    datasets: [
      {
        label: 'Repair Prices',
        data: prices,
        borderColor: 'rgba(0, 176, 255, 1)',
        backgroundColor: gradientBlue,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#00b0ff',
        pointRadius: 5,
        fill: true,
        tension: 0.4,
      },
    ],
  };

  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Repair Prices Over Time',
        },
      },
    },
  });
}
initializeChart();
</script>

<div class="body-wrapper" style="margin-top: 8rem !important;">
  <div class="container-fluid">
    <div class="card card-body py-3">
      <div class="row align-items-center">
        <div class="col-md-12">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-4 mb-sm-0 card-title">Repair</h4>
            <i class="icon fa-solid fa-screwdriver-wrench" style="font-size:17px;padding-left:5px;"></i>
            <form class="position-relative ms-auto">
              <input type="text" class="form-control search-chat py-2 ps-5" id="text-srh" placeholder="Search  Product ">
              <i class="fa-solid fa-magnifying-glass position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
            </form>
                         <!-- Status Filter Dropdown -->
                              <div class="filter-container ms-3">
                                <select id="statusFilter" class="form-selects" onchange="filterTable()">
                                  <option value="All">All</option>
                                  <option value="Pending">Pending</option>
                                  <option value="Cancelled">Cancelled</option>
                                  <option value="Progress">Progress</option>
                                  <option value="Completed">Completed</option>
                                  <option value="Delivered">Delivered</option>
                                </select>
                                   </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                        
    <div class="card card-body" >
      <div class="table-responsive">
        <table class="table search-table align-middle text-nowrap" id="paginatedTable">
          <thead class="header-item text-center" >
            <tr>
              <th>Full Name</th>
              <th>Product Name</th> 
              <th>Price</th>
              <th>Status</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="table-body" class="text-center">
            <% products.forEach(product => { %>
            <tr class="search-items" data-user-id="<%= product.id %>">
              <td><span class="usr-name mb-0 text-dark"><%= product.fullName %></span></td>
              <td><span class="usr-location text-dark"><%= product.brand %></span></td>
              <td><span class="usr-price text-dark"> <%= product.Price %></span></td>
              <td style="display: none;"><span class="usr-select <%= product.mobileNumber %>"><%= product.mobileNumber %></span></td>
              <td>
                <select class="status-select <%= product.status %>" onchange="updateStatus('<%= product.id %>', this.value)">
                  <option value="Pending" <%= product.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                  <option value="Cancelled" <%= product.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                  <option value="Progress" <%= product.status === 'Progress' ? 'selected' : '' %>>Progress</option>
                  <option value="Completed" <%= product.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                  <option value="Delivered" <%= product.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                </select>
              </td>
              <td>
                <div class="action-btn d-flex justify-content-center">
                  <button class="btn text-black" onclick="printTable('<%= product.id %>')">
                    <i class="fa fa-print"></i> Print
                  </button>
                  
                  <form action="/repair/<%= product.id %>" method="POST">
                    <button type="submit" class="btn btn-link text-danger">
                      <i class="fa-solid fa-trash-can text-danger"></i>
                    </button>
                  </form>
                  
                  <button class="btn text-primary" onclick="generateQRCode('[<%= product.random_id%>, <%= product.fullName %>,<%= product.brand %>,<%= product.status %>]')">
                    <i class="fas fa-qrcode"></i> Generate QR
                  </button>
                  
                  <!-- Edit Button -->
                </button>
                <button type="button" class="btn btn-link text-primary edit" data-bs-toggle="modal" data-bs-target="#editUserModal<%= product.id %>"> 
                  <i class="fs-4 fa-solid fa-pen-to-square text-primary"></i>
                </button>
                  
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="tableInfo" class="text-muted">Showing 1 to 10 of <%= products.length %> entries</span>
        <nav style="margin-right:31px;">
          <ul class="pagination" id="pagination"></ul>
        </nav>
      </div>
    </div>
  <!-- Content End -->

  <% products.forEach(product => { %>
    <div class="modal fade" id="editUserModal<%= product.id %>" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content gadget-form-modal" style="width:100%;">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel" style="margin-left: auto; font-size: xx-large;margin-bottom: -17px;">Update Clients</h5>
            <button type="button" class="btn-close gadget-close-btn" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times gadget-close-btn" data-bs-dismiss="modal" aria-label="Close"></i></button>
          </div>
  
          <div class="modal-body"  style="padding-top: 17px;">
            <form action="/Clients/update/<%= product.id %>" method="POST" id="editUserForm<%= product.id %>" class="gadget-form">
              <input type="hidden" name="id" value="<%= product.id %>" />
              <div class="col-md-12">
                <label for="fullName-<%= product.id %>" class="form-label">Full Name</label>
                <input type="text" class="form-control gadget-input" name="fullName" id="fullName-<%= product.id %>" value="<%= product.fullName %>" required>
              </div>
              <div class="col-md-12">
                <label for="email-<%= product.id %>" class="form-label">Email</label>
                <input type="email" class="form-control gadget-input" name="email" id="email-<%= product.id %>" value="<%= product.email %>" required>
              </div>
              <div class="row">
                <div class="row ">
                  <div class="col-md-6 ">
                      <label for="brand" class="form-label">Brand Name</label>
                      <select class="form-select gadget-select" name="brand" id="Brand" required>
                          <% brand.forEach(brand => { %>
                              <option value="<%= brand.name %>">
                                <%= brand.name %>
                              </option>
                            <% }); %>
                            <option value="Vivo">Vivo</option>
                      </select>  
                  </div>
                <div class="form-group col-md-6">
                  <label for="status-<%= product.id %>" class="form-label">Status</label>
                  <select class="form-control gadget-select status-select <%= product.status %>" id="status-<%= product.id %>" name="status" onchange="updateStatus('<%= product.id %>', this.value)">
                    <option value="Pending" <%= product.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                    <option value="Cancelled" <%= product.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                    <option value="Progress" <%= product.status === 'Progress' ? 'selected' : '' %>>Progress</option>
                    <option value="Completed" <%= product.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                    <option value="Delivered" <%= product.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                  </select>
                </div>
              </div>
            </div>
              <!-- Submit Button -->
              <div class="btn-add">
                <button type="submit" class="btn gadget-submit-btn" style=" background-color: #28a745; color: white;">
                  Update Clients
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <% }); %>
<!-- footer -->
<footer class="footer  text-lg-start">  
  <div class="p3 text-center">  
    Developed By <a style="color: black;" href="https://www.clicktaketech.com" target="_blank"><U>ClickTake Technologies</U></a> Copyright © 2025 DibNow || version 1.0.0

  </div>   
</footer>
<!-- footer -->

<script>
// QR Code Scanner
let qrDiv = document.getElementById("QR-div");
let qrImage = document.getElementById("QR-image");

function generateQRCode(productId) {
  let randomData = Math.random().toString(36).substr(2, 9);
  let qrData = `Product ID: ${productId}, Ref: ${randomData}`;
  // Generate QR Code URL
  let qrCodeURL = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(qrData);
  qrImage.src = qrCodeURL;
  
  qrDiv.style.display = "block";
}
function closeQRModal() {
  qrDiv.style.display = "none";
}
window.onclick = function (event) {
  if (event.target == qrDiv) {
    qrDiv.style.display = "none";
  }
};
// End QR Code Scanner

// Update status
        function updateStatus(productId, status) {
    fetch(`/repair/${productId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status }),
    })
    .then(response => {
        if (response.ok) {
            console.log("Status updated successfully");
        }
    })
    .catch(error => {
        console.error("Error updating status:", error);
    });
}

// Search Filter
document.getElementById('text-srh').addEventListener('input', function () {
   const searchTerm = this.value.toLowerCase();
   const tableRows = document.querySelectorAll('#paginatedTable tbody .search-items'); 
   
   tableRows.forEach(row => {
     const fullName = row.querySelector('td:first-child .usr-name').textContent.toLowerCase();
     const productName = row.querySelector('td:nth-child(2) .usr-location').textContent.toLowerCase();

     if (fullName.includes(searchTerm) || productName.includes(searchTerm)) {
       row.style.display = '';
     } else {
       row.style.display = 'none';
     }
   });
});

// Filter by Status
function filterTable() {
   const statusFilter = document.getElementById('statusFilter').value; 
   const tableRows = document.querySelectorAll('#paginatedTable tbody .search-items'); 
   
   tableRows.forEach(row => {
     const productStatus = row.querySelector('td:nth-child(5) select').value; // Fix: Changed to 5th column
     
     if (statusFilter === 'All' || productStatus === statusFilter) {
       row.style.display = '';
     } else {
       row.style.display = 'none'; 
     }
   });
}

// Table pagination // Table pagination
document.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("paginatedTable");
  const rows = table.querySelectorAll("tbody tr");
  const pagination = document.getElementById("pagination");
  const tableInfo = document.getElementById("tableInfo");

  const rowsPerPage = 10;
  const totalPages = Math.ceil(rows.length / rowsPerPage);
  let currentPage = 1;

  const showPage = (page) => {
    currentPage = page;
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    rows.forEach((row, index) => {
      row.style.display = index >= start && index < end ? "" : "none";
    });

    tableInfo.textContent = `Showing ${start + 1} to ${
      end > rows.length ? rows.length : end
    } of ${rows.length} entries`;

    updatePagination();
  };

  const updatePagination = () => {
    pagination.innerHTML = ""; 

    const createPageItem = (page, label, isDisabled = false, isActive = false) => {
      const li = document.createElement("li");
      li.className = `page-item ${isActive ? "active" : ""} ${isDisabled ? "disabled" : ""}`;
      li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
      li.addEventListener("click", (e) => {
        e.preventDefault();
        if (!isDisabled) {
          if (label === "Previous") {
            showPage(currentPage - 1);
          } else if (label === "Next") {
            showPage(currentPage + 1);
          } else {
            showPage(page);
          }
        }
      });
      return li;
    };

    pagination.appendChild(
      createPageItem(currentPage - 1, "Previous", currentPage === 1)
    );

    for (let i = 1; i <= totalPages; i++) {
      pagination.appendChild(
        createPageItem(i, i, false, i === currentPage)
      );
    }

    pagination.appendChild(
      createPageItem(currentPage + 1, "Next", currentPage === totalPages)
    );
  };

  showPage(1);
});


// Print button // Print button // Print button 
function printTable(userId) {
    if (userId) {
        var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);

        if (userRow) {
            // Get current date and time
            let now = new Date();
            let formattedDate = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            let formattedTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let liveDate = `${formattedDate}`;
            let liveTime = `${formattedTime}`;

            // Generate QR Code for the product
            let randomData = Math.random().toString(36).substr(2, 9);
            let qrData = `Product ID: ${userId},  Ref: ${randomData}`;
            let qrCodeURL = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(qrData);

            // Open a new window for printing
            var printWindow = window.open('ss', 'PrintWindow', 'height=600,width=800');

            printWindow.document.open();
            printWindow.document.write(`
                <html>
                    <head>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 0;
                                padding: 0;
                            }
                            h1 {
                                text-align: center;
                                color: #333;
                            }
                            .live-date {
                                margin-left: 20px;
                                font-size: 14px;
                                font-weight: bold;
                            }
                            .user-details {
                                margin: 20px;
                                padding: 20px;
                                border-radius: 8px;
                            }
                            .customer-footer {
                                margin-top: 180px;
                                text-align: center;
                                font-weight: bold;
                            }
                            .qr-code {
                                margin-top: 100px;
                                text-align: center;
                            }
                            img {
                                width: 300px;
                                height: 300px;
                            }
                            .date {
                                display: flex;
                                justify-content: space-between;
                                margin-left: 20px;
                            }
                            .dates {
                               display: flex;
                               justify-content: space-between;
                               margin-left: 20px;
                               border-bottom: 3px double #ccc;
                            }
                            .info-section {
                                margin: 20px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                border-bottom: 1px solid #ccc;
                            }
                            .info-section h5 {
                                margin-right: 10px;
                                font-weight: bold;
                            }
                            .info-section .left,
                            .info-section .center,
                            .info-section .right {
                                flex: 1;
                                text-align: center;
                            }
                            .center {
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <h1><%- company %></h1>
                        <div class="date">
                            <p class="live-date">Date: ${liveDate}</p> 
                            <p class="live-date">Time: ${liveTime}</p> 
                        </div>
                        <div class="date">
                            <p class="live-date">Name: ${userRow.querySelector('.usr-name').innerText}</p>
                            <p class="live-date">Ref: ${randomData}</p>
                        </div>
                         <div class="dates">
                            <p class="live-date">Number: ${userRow.querySelector('.usr-select').innerText}</p>
                        </div>
                        <div class="info-section">
                            <div class="left">
                                <h5>Product</h5>
                                <p>${userRow.querySelector('.usr-location').innerText}</p>
                            </div>
                            <div class="right">
                                <h5>Price</h5>
                                <p>${userRow.querySelector('.usr-price').innerText}</p>
                            </div>
                             <div class="center">
                                <h5>Status</h5>
                                <p>${userRow.querySelector('.status-select').value}</p>
                            </div>
                        </div>

                        <!-- QR Code Section -->
                        <div class="qr-code">
                            <h3>QR Code for User Details</h3>
                            <img src="${qrCodeURL}" alt="QR Code" />
                        </div>

                        <!-- Customer Details Footer -->
                        <div class="customer-footer">
                            <p>Developed By ClickTake Technologies © 2025 DibNow</p>
                        </div>
                    </body>
                </html>
            `);
            // Close the document to prepare it for printing
            printWindow.document.close();

            // Wait for the image to load and then call print
            printWindow.onload = function () {
                printWindow.focus(); 
                printWindow.print();
                printWindow.close();
            };
        }
    }
}
</script>
    </body>
        <!-- JavaScript Libraries -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
    
        <!-- Template Javascript -->
        <script src="js/main.js"></script>
        <script src="js/updateStatus.js"></script>
    </html>



