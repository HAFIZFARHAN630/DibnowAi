<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Repair Status</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

        <!-- Favicon -->
            <link rel="icon" href="\images\DIB-NOW-512.png" type="image/x-icon">

    
    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Customized Bootstrap Stylesheet -->
    <link href="bootstrap.css" rel="stylesheet">
    <!-- Template Stylesheet -->
    <link href="styles.css" rel="stylesheet">
    <link href="styles1.css" rel="stylesheet">
    <style>

      .body-wrapper {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }

      .footer {
          margin-top: auto;
          padding: 5px 80px 5px 30px;
          background-color: #dadae0;
          text-align: center;
          width: 109%;
          margin-left: -35px;
            }

      /* Colorful Dropdown Styles */
      .form-selects, .status-select {
        font-weight: 600;
        border-radius: 8px;
        padding: 8px 12px;
        border: 2px solid;
        transition: all 0.3s ease;
        color: white;
      }

      .form-selects option, .status-select option {
        font-weight: 600;
        padding: 10px;
      }

      /* Filter Dropdown Dynamic Colors */
      .form-selects.filter-All { background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%); border-color: #6c757d; }
      .form-selects.filter-Pending { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-color: #ffc107; }
      .form-selects.filter-Cancelled { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-color: #dc3545; }
      .form-selects.filter-Progress { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border-color: #007bff; }
      .form-selects.filter-Completed { background: linear-gradient(135deg, #28a745 0%, #218838 100%); border-color: #28a745; }
      .form-selects.filter-Delivered { background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); border-color: #6f42c1; }

      /* Filter Dropdown Option Colors */
      .form-selects option[value="All"] { background: #6c757d; color: white; }
      .form-selects option[value="Pending"] { background: #ffc107; color: white; }
      .form-selects option[value="Cancelled"] { background: #dc3545; color: white; }
      .form-selects option[value="Progress"] { background: #007bff; color: white; }
      .form-selects option[value="Completed"] { background: #28a745; color: white; }
      .form-selects option[value="Delivered"] { background: #6f42c1; color: white; }

      /* Status Select Colors */
      .status-select.Pending { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border-color: #ffc107; }
      .status-select.Cancelled { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border-color: #dc3545; }
      .status-select.Progress { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-color: #007bff; }
      .status-select.Completed { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border-color: #28a745; }
      .status-select.Delivered { background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; border-color: #6f42c1; }

      .status-select option[value="Pending"] { background: #ffc107; color: white; }
      .status-select option[value="Cancelled"] { background: #dc3545; color: white; }
      .status-select option[value="Progress"] { background: #007bff; color: white; }
      .status-select option[value="Completed"] { background: #28a745; color: white; }
      .status-select option[value="Delivered"] { background: #6f42c1; color: white; }

      .btn-gradient {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: 2px solid rgba(16, 185, 129, 0.3);
        border-radius: 15px;
        color: white;
        font-weight: 700;
        padding: 12px 25px;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #text-srh {
        border-radius: 25px;
        background-color: #f8f9fa;
        border: 2px solid #e9ecef;
        color: #212529;
        padding: 10px 20px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      #text-srh:focus {
        background-color: #ffffff;
        border-color: #10b981;
        box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
        color: #212529;
      }

      #text-srh::placeholder {
        color: #6c757d;
      }

      .btn-gradient:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3);
        color: white;
      }

      /* Search functionality */
      .search-container {
        position: relative;
        
      }

      .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 10;
      }

      .search-input-wrapper {
        position: relative;
      }

      .search-input-wrapper input {
        padding-left: 45px;
      }

      /* Enhanced Table Design */
      .table {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: none;
      }

      .table thead th {
        background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        padding: 20px 15px;
        font-size: 14px;
      }

      .table tbody tr {
        transition: all 0.3s ease;
        border: none;
      }

      .table tbody tr:hover {
        background-color: #f8f9ff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .table tbody td {
        padding: 18px 15px;
        border: none;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
      }

      /* Button Styling */
      .btn-action {
        border-radius: 8px;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.3s ease;
      }

      .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      /* Action Button Styles */
      .action-btn .btn {
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .action-btn .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .action-btn .btn.text-black {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white !important;
        border-color: #6c757d;
      }

      .action-btn .btn.text-black:hover {
        background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
      }

      .action-btn .btn.text-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white !important;
        border-color: #007bff;
      }

      .action-btn .btn.text-primary:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      }

      .action-btn .btn-link.text-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white !important;
        border-color: #dc3545;
        text-decoration: none;
        padding: 8px 12px;
      }

      .action-btn .btn-link.text-danger:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
      }

      .action-btn .btn-link.text-danger i {
        color: white !important;
      }

      .table tbody tr.search-hidden {
        display: none;
      }

      .table tbody tr.pagination-hidden {
        display: none !important;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .no-results i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      /* Status Filter Styling */
      .form-selects {
        border-radius: 25px;
        background-color: #f8f9fa;
        border: 2px solid #e9ecef;
        color: #212529;
        padding: 10px 20px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .form-selects:focus {
        background-color: #ffffff;
        border-color: #10b981;
        box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
        color: #212529;
      }

      /* Modal Redesign - Matching add_team_member.ejs */
      .modal-content.gadget-form-modal {
        background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%);
        border-radius: 25px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 30px 100px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(15px);
      }

      .modal-header {
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        padding: 30px;
        position: relative;
      }

      .modal-title {
        color: #ffffff !important;
        font-weight: 700 !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        margin: 0 !important;
        font-size: 28px !important;
      }

      .gadget-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .gadget-close-btn:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .modal-body {
        padding: 30px;
      }

      .gadget-form .form-label {
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 12px;
        font-size: 16px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .gadget-form .gadget-input,
      .gadget-form .gadget-select {
        width: 100%;
        height: 50px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 12px 20px;
        font-size: 16px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
        transition: all 0.3s ease;
        margin-bottom: 15px;
      }

      .gadget-form .gadget-input:focus,
      .gadget-form .gadget-select:focus {
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.98);
      }

      .gadget-submit-btn {
        width: 100%;
        height: 50px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: #0033cc;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
        text-transform: uppercase;
        margin-top: 20px;
      }

      .gadget-submit-btn:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 255, 255, 0.3);
      }

      /* Edit Button Styling */
      .action-btn .btn-link.text-primary.edit {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white !important;
        border-color: #007bff;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 8px;
      }

      .action-btn .btn-link.text-primary.edit:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      }

      .action-btn .btn-link.text-primary.edit i {
        color: white !important;
      }

      /* Professional Pagination Buttons */
      .pagination .page-link {
        background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%) !important;
        color: white !important;
        border: none !important;
        font-weight: 600 !important;
        padding: 10px 24px !important;
        min-width: 120px !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 8px rgba(0, 51, 204, 0.3) !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .pagination .page-link:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0, 51, 204, 0.4) !important;
      }

      .pagination .page-item.disabled .page-link {
        background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%) !important;
        opacity: 0.6 !important;
        cursor: not-allowed !important;
      }

      .pagination .page-item {
        margin: 0 4px !important;
      }
      .action-buttons-b{
        display: flex;
        align-items: center;
        margin-top: 20px;
        gap: 15px;
justify-content: flex-end;    
  }
      @media screen and (max-width: 768px) {
        .action-buttons-b {
          flex-direction: column;
          gap: 10px;
        }
        .action-buttons-b button{
          width: 100% important;
        }
      }
    </style>
   
</head>
<body>

  <!--  -->
  <%- include('../par/Add_Repair.ejs') %>
  <!--  -->

               <%- include('../par/sidebar.ejs') %>

  <!-- Navbar Start -->
  <%- include('../par/header.ejs') %>


  <% if (success_msg.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong><i class="icon fa fa-check-circle me-2"></i><%= success_msg %></strong> 
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>
<% if (error_msg.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><%= error_msg %></strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>

<div  class="action-buttons-b">
  <button class="btn btn-action btn-danger" data-bs-toggle="modal" data-bs-target="#gadgetRepairModal"><i class="bi bi-tools"></i> Add Repair Customer </button> 
  <button class="btn btn-action btn-primary" data-bs-toggle="modal" data-bs-target="#gadgetrModal"><i class="bi bi-clipboard-data"></i> Add Inventory</button>
</div>
    <!-- Navbar End -->


<!-- graph -->
<div class="container-fluid pt-4 px-1">
  <div class="row g-4">
    <!-- Chart Container -->
    <div class="col-12 col-md-12">
      <div class="h-100 p-4" style="border-radius: 15px; background-color: #fff; max-width: 100%; width: 100%;">
        <!-- Overview Content -->
        <h6 class="text-dark mb-3">Monthly Earnings</h6>
        <div style="position: relative; height: 300px;">
          <canvas id="earningsChart"></canvas>
        </div>
      </div>
    </div>
<!-- Script for Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('earningsChart').getContext('2d');

// Function to fetch repair prices from the backend
async function fetchRepairPrices() {
  try {
    const response = await fetch('/api/repair-prices');
    if (!response.ok) throw new Error("Failed to fetch repair prices");
    const prices = await response.json();
    return prices;
  } catch (error) {
    console.error("Error fetching repair prices:", error);
    return [];
  }
}

// Function to initialize the chart
async function initializeChart() {
  const prices = await fetchRepairPrices();

  const createGradient = (ctx, colorStart, colorEnd) => {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, colorStart);
    gradient.addColorStop(1, colorEnd);
    return gradient;
  };

  const gradientBlue = createGradient(ctx, 'rgba(0, 176, 255, 0.8)', 'rgba(0, 176, 255, 0)');

  const chartData = {
    labels: Array.from({ length: prices.length }, (_, i) => i + 1), // Generate labels for each price
    datasets: [
      {
        label: 'Repair Prices',
        data: prices,
        borderColor: 'rgba(0, 176, 255, 1)',
        backgroundColor: gradientBlue,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#00b0ff',
        pointRadius: 5,
        fill: true,
        tension: 0.4,
      },
    ],
  };

  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Repair Prices Over Time',
        },
      },
    },
  });
}
initializeChart();
</script>

<div class="body-wrapper" style="margin-top: 8rem !important;">
  <div class="">
<div class="card card-body py-3">
 <div class="row align-items-center">
    <div class="col-md-12">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h4 class="mb-4 mb-sm-0 card-title">Repair</h4>
        <i class="icon fa-solid fa-screwdriver-wrench" style="font-size:17px;padding-left:5px;"></i>
        
        <div class="search-container flex-grow-1" style="min-width:200px;">
          <div class="search-input-wrapper w-100">
            <input type="text" id="text-srh" class="form-control" placeholder="Search Product">
          </div>
        </div>
        
        <!-- Status Filter Dropdown -->
        <div class="filter-container ms-sm-3 w-auto flex-grow-1" style="min-width:150px;">
          <select id="statusFilter" class="form-selects w-100" onchange="filterTable()">
            <option value="All">All</option>
            <option value="Pending">Pending</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Progress">Progress</option>
            <option value="Completed">Completed</option>
            <option value="Delivered">Delivered</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

 <style>
/* Bootstrap-only tweak for small screens */
@media (max-width: 575.98px) {
  .d-flex.flex-wrap.justify-content-between {
    justify-content: center !important; /* center items when wrapped */
    text-align: center;
  }
  .d-flex.flex-wrap > div {
    flex: 0 0 100%; /* each item full-width */
    max-width: 100%;
  }
  .d-flex.flex-wrap > div input,
  .d-flex.flex-wrap > div select {
    margin: 0 auto; /* center input/select */
  }
}
</style>

                        
    <div class="card card-body" >
<!-- Table (shown on md+ screens) -->
<div class="table-responsive d-none d-xl-block">
  <table class="table search-table align-middle text-nowrap" id="paginatedTable">
    <thead class="header-item text-center">
      <tr>
        <th style="width: 50px;">
          <input type="checkbox" id="selectAllRepair" class="form-check-input" style="cursor: pointer; width: 18px; height: 18px;">
        </th>
        <th>Full Name</th>
        <th>Product Name</th>
        <th>Price</th>
        <th>Tracking ID</th>
        <th>Status</th>
        <th class="text-center">Action</th>
      </tr>
    </thead>
    <tbody id="table-body" class="text-center">
      <% products.forEach(product => { %>
      <tr class="search-items repair-row" data-user-id="<%= product.id %>">
        <td>
          <input type="checkbox" class="repair-row-checkbox form-check-input" data-id="<%= product.id %>" style="cursor: pointer; width: 18px; height: 18px;">
        </td>
        <td>
          <span class="usr-name mb-0 text-dark"><%= product.fullName %></span>
          <span class="usr-select" style="display:none;"><%= product.mobileNumber %></span>
        </td>
        <td><span class="usr-location text-dark"><%= product.brand %></span></td>
        <td><span class="usr-price text-dark"><%= product.Price %></span></td>
        <td>
          <span class="usr-tracking-id text-dark font-mono" style="font-size: 12px; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; display: inline-block;" title="Click to copy" onclick="copyToClipboard('<%= product.random_id %>')">
            <%= product.random_id || 'N/A' %>
          </span>
        </td>
        <td>
          <select class="status-select <%= product.status %>" onchange="updateStatus('<%= product.id %>', this.value)">
            <option value="Pending" <%= product.status === 'Pending' ? 'selected' : '' %>>Pending</option>
            <option value="Cancelled" <%= product.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
            <option value="Progress" <%= product.status === 'Progress' ? 'selected' : '' %>>Progress</option>
            <option value="Completed" <%= product.status === 'Completed' ? 'selected' : '' %>>Completed</option>
            <option value="Delivered" <%= product.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
          </select>
        </td>
        <td>
          <div class="action-btn d-flex justify-content-center flex-wrap gap-2">
            <button class="btn text-black" onclick="printTable('<%= product.id %>')">
              <i class="fa fa-print"></i> Print
            </button>

            <form action="/repair/<%= product.id %>" method="POST">
              <button type="submit" class="btn btn-link text-danger">
                <i class="fa-solid fa-trash-can text-danger"></i>
              </button>
            </form>

            <button class="btn text-primary" onclick="generateQRCode('<%= product.id %>', '<%= product.fullName %>', '<%= product.mobileNumber %>', '<%= product.brand %>', '<%= product.Price %>', '<%= product.status %>')">
              <i class="fas fa-qrcode"></i> Generate QR
            </button>

            <button type="button" class="btn btn-link text-primary edit" data-bs-toggle="modal" data-bs-target="#editUserModal<%= product.id %>">
              <i class="fs-4 fa-solid fa-pen-to-square text-primary"></i>
            </button>
          </div>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>


<!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="tableInfo" class="text-muted">Showing 1 to 10 of <%= products.length %> entries</span>
        <nav style="margin-right:31px;">
          <ul class="pagination" id="pagination"></ul>
        </nav>
      </div>

<!-- Card layout (shown on small screens) -->
<div class="d-xl-block d-xl-none">
  <% products.forEach(product => { %>
  <div class="card mb-4 shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title mb-3 text-primary">
        <i class="fa fa-user me-2"></i><%= product.fullName %>
      </h5>

      <p class="mb-2"><span class="fw-semibold text-secondary">Product:</span> <%= product.brand %></p>
      <p class="mb-2"><span class="fw-semibold text-secondary">Price:</span> $<%= product.Price %></p>
      <p class="mb-2">
        <span class="fw-semibold text-secondary">Tracking ID:</span>
        <span class="font-mono text-primary" style="font-size: 14px; background: #f8f9fa; padding: 2px 6px; border-radius: 3px;" onclick="copyToClipboard('<%= product.random_id %>')" title="Click to copy">
          <%= product.random_id || 'N/A' %>
        </span>
      </p>

      <div class="mb-3">
        <span class="fw-semibold text-secondary me-2">Status:</span>
        <select class="form-select form-select-sm w-auto d-inline-block <%= product.status %>"
          onchange="updateStatus('<%= product.id %>', this.value)">
          <option value="Pending" <%= product.status === 'Pending' ? 'selected' : '' %>>Pending</option>
          <option value="Cancelled" <%= product.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
          <option value="Progress" <%= product.status === 'Progress' ? 'selected' : '' %>>Progress</option>
          <option value="Completed" <%= product.status === 'Completed' ? 'selected' : '' %>>Completed</option>
          <option value="Delivered" <%= product.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
        </select>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-sm btn-outline-dark" onclick="printTable('<%= product.id %>')" title="Print">
          <i class="fa fa-print"></i>
        </button>

        <form action="/repair/<%= product.id %>" method="POST" class="d-inline">
          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </form>

        <button class="btn btn-sm btn-outline-primary"
          onclick="generateQRCode('<%= product.id %>', '<%= product.fullName %>', '<%= product.mobileNumber %>', '<%= product.brand %>', '<%= product.Price %>', '<%= product.status %>')" title="Generate QR">
          <i class="fas fa-qrcode"></i>
        </button>

        <button type="button" class="btn btn-sm btn-outline-primary edit"
          data-bs-toggle="modal" data-bs-target="#editUserModal<%= product.id %>" title="Edit">
          <i class="fa-solid fa-pen-to-square"></i>
        </button>
      </div>
    </div>
  </div>
  <% }); %>
</div>

    </div>
  </div>
</div>

<!-- Delete Selected Button -->
<div class="mb-4">
  <button id="deleteSelectedBtn"
          data-table="repair"
          class="btn btn-danger shadow-sm px-4 py-2 fw-semibold"
          style="display: none;">
    <i class="fas fa-trash-alt me-2"></i> Delete Selected
  </button>
</div>

      
    </div>
  <!-- Content End -->

  <% products.forEach(product => { %>
    <div class="modal fade" id="editUserModal<%= product.id %>" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content gadget-form-modal" style="width:100%;">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">Update Clients</h5>
            <button type="button" class="gadget-close-btn" data-bs-dismiss="modal" aria-label="Close">
              <i class="fas fa-times"></i>
            </button>
          </div>
  
          <div class="modal-body"  style="padding-top: 17px;">
            <form action="/Clients/update/<%= product.id %>" method="POST" id="editUserForm<%= product.id %>" class="gadget-form">
              <input type="hidden" name="id" value="<%= product.id %>" />
              <div class="col-md-12">
                <label for="fullName-<%= product.id %>" class="form-label">Full Name</label>
                <input type="text" class="form-control gadget-input" name="fullName" id="fullName-<%= product.id %>" value="<%= product.fullName %>" required>
              </div>
              <div class="col-md-12">
                <label for="email-<%= product.id %>" class="form-label">Email</label>
                <input type="email" class="form-control gadget-input" name="email" id="email-<%= product.id %>" value="<%= product.email %>" required>
              </div>
              <div class="row">
                <div class="row ">
                  <div class="col-md-6 ">
                      <label for="brand" class="form-label">Brand Name</label>
                      <select class="form-select gadget-select" name="brand" id="Brand" required>
                          <% brand.forEach(brand => { %>
                              <option value="<%= brand.name %>">
                                <%= brand.name %>
                              </option>
                            <% }); %>
                            <option value="Vivo">Vivo</option>
                      </select>  
                  </div>
                <div class="form-group col-md-6">
                  <label for="status-<%= product.id %>" class="form-label">Status</label>
                  <select class="form-control gadget-select status-select <%= product.status %>" id="status-<%= product.id %>" name="status" onchange="updateStatus('<%= product.id %>', this.value)">
                    <option value="Pending" <%= product.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                    <option value="Cancelled" <%= product.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                    <option value="Progress" <%= product.status === 'Progress' ? 'selected' : '' %>>Progress</option>
                    <option value="Completed" <%= product.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                    <option value="Delivered" <%= product.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                  </select>
                </div>
              </div>
            </div>
              <!-- Submit Button -->
              <div class="btn-add">
                <button type="submit" class="btn gadget-submit-btn">
                  Update Clients
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <% }); %>
<!-- QR Code Modal -->
<div id="QR-div" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:15px; text-align:center; position:relative;">
    <button onclick="closeQRModal()" style="position:absolute; top:10px; right:10px; background:#ff6b6b; border:none; border-radius:50%; width:35px; height:35px; color:white; cursor:pointer; font-size:18px;">&times;</button>
    <h3 style="margin-bottom:20px; color:#333;">QR Code</h3>
    <img id="QR-image" src="" alt="QR Code" style="width:300px; height:300px; border-radius:0;" />
  </div>
</div>



  <!-- footer -->
  <%- include('../par/footer.ejs') %>
  <!-- footer -->

<script>
document.addEventListener("DOMContentLoaded", () => {
  const selectAll = document.getElementById("selectAllRepair");
  const checkboxes = document.querySelectorAll(".repair-row-checkbox");
  const deleteBtn = document.getElementById("deleteSelectedBtn");

  const toggleButton = () => {
    const selected = document.querySelectorAll(".repair-row-checkbox:checked").length;
    deleteBtn.style.display = selected > 0 ? "inline-flex" : "none";
  };

  if (selectAll) {
    selectAll.addEventListener("change", () => {
      checkboxes.forEach(cb => {
        if (cb.closest('tr').style.display !== 'none') {
          cb.checked = selectAll.checked;
        }
      });
      toggleButton();
    });
  }

  checkboxes.forEach(cb => cb.addEventListener("change", () => {
    const visibleCheckboxes = Array.from(checkboxes).filter(checkbox =>
      checkbox.closest('tr').style.display !== 'none'
    );
    const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
    if (selectAll) selectAll.checked = allChecked;
    toggleButton();
  }));

  deleteBtn.addEventListener("click", async () => {
    const selectedIds = [...document.querySelectorAll(".repair-row-checkbox:checked")].map(cb => cb.dataset.id);
    if (selectedIds.length === 0) return alert("Please select at least one repair item to delete.");
    if (!confirm(`Delete ${selectedIds.length} selected repair item(s)?`)) return;

    try {
      const tableName = deleteBtn.dataset.table; // "repair"
      const res = await fetch(`/delete-selected/${tableName}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ selectedIds }),
      });

      const data = await res.json();
      if (data.success) {
        selectedIds.forEach(id => {
          const row = document.querySelector(`tr[data-user-id="${id}"]`);
          if (row) row.remove();
        });
        alert("Selected repair items deleted successfully.");
        toggleButton();
      } else {
        alert("Error deleting repair items: " + data.message);
      }
    } catch (err) {
      console.error(err);
      alert("Something went wrong.");
    }
  });

  toggleButton();
});

// QR Code Scanner
function generateQRCode(userId, userName, userNumber, productName, price, status) {
  let qrDiv = document.getElementById("QR-div");
  let qrImage = document.getElementById("QR-image");
  
  let now = new Date();
  let formattedDate = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  let formattedTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  let randomData = Math.random().toString(36).substr(2, 9);
  
  // Create simple text format that works with all QR scanners
  let qrData = "REPAIR INVOICE\n" +
               "Date: " + formattedDate + " " + formattedTime + "\n" +
               "Ref: " + randomData + "\n" +
               "Name: " + userName + "\n" +
               "Number: " + userNumber + "\n" +
               "Product: " + productName + "\n" +
               "Price: " + price + "\n" +
               "Tracking ID: " + trackingId + "\n" +
               "Status: " + status + "\n" +
               "ID: " + userId;
  
  let qrCodeURL = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(qrData);
  
  qrImage.src = qrCodeURL;
  qrDiv.style.display = "flex";
}

function closeQRModal() {
  document.getElementById("QR-div").style.display = "none";
}

window.onclick = function (event) {
  let qrDiv = document.getElementById("QR-div");
  if (event.target == qrDiv) {
    qrDiv.style.display = "none";
  }
};
// End QR Code Scanner

// Copy tracking ID to clipboard
function copyToClipboard(text) {
  if (text && text !== 'N/A') {
    navigator.clipboard.writeText(text).then(() => {
      // Show success feedback
      showNotification('Tracking ID copied to clipboard!', 'success');
    }).catch(() => {
      showNotification('Failed to copy tracking ID', 'error');
    });
  }
}

// Notification system
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 px-6 py-4 rounded-2xl shadow-xl z-50 transform translate-x-full transition-transform duration-300 ${
    type === 'success' ? 'bg-green-500 text-white' :
    type === 'error' ? 'bg-red-500 text-white' :
    'bg-blue-500 text-white'
  }`;
  notification.innerHTML = `
    <div class="flex items-center">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-3"></i>
      <span>${message}</span>
    </div>
  `;

  document.body.appendChild(notification);

  // Animate in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);

  // Remove after 4 seconds
  setTimeout(() => {
    notification.style.transform = 'translateX(full)';
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 4000);
}

// Update status
function updateStatus(productId, status) {
    const selectElement = event.target;
    selectElement.className = 'status-select ' + status;

    fetch(`/repair/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status }),
    })
    .then(response => {
        if (response.ok) {
            console.log("Status updated successfully");

            // If status is changed to "Completed", trigger dashboard refresh
            if (status === 'Completed') {
                // Notify dashboard to refresh the completed tasks chart
                if (window.refreshDashboardChart) {
                    window.refreshDashboardChart();
                }

                // Also trigger a global event that index.ejs can listen to
                window.dispatchEvent(new CustomEvent('repairStatusUpdated', {
                    detail: { status: status, productId: productId }
                }));
            }
        }
    })
    .catch(error => console.error("Error updating status:", error));
}

// Search Filter
document.getElementById('text-srh').addEventListener('input', function () {
   const searchTerm = this.value.toLowerCase();
   const tableRows = document.querySelectorAll('#paginatedTable tbody .search-items');

   tableRows.forEach(row => {
     const fullName = row.querySelector('td:first-child .usr-name').textContent.toLowerCase();
     const productName = row.querySelector('td:nth-child(2) .usr-location').textContent.toLowerCase();
     const trackingId = row.querySelector('td:nth-child(4) .usr-tracking-id').textContent.toLowerCase();

     if (fullName.includes(searchTerm) || productName.includes(searchTerm) || trackingId.includes(searchTerm)) {
       row.style.display = '';
     } else {
       row.style.display = 'none';
     }
   });

   updatePaginationAfterFilter();
 });

// Filter by Status
function filterTable() {
   const statusFilterEl = document.getElementById('statusFilter');
   const statusFilter = statusFilterEl.value; 
   const tableRows = document.querySelectorAll('#paginatedTable tbody .search-items'); 
   
   // Update filter dropdown color
   statusFilterEl.className = 'form-selects w-100 filter-' + statusFilter;
   
   tableRows.forEach(row => {
     const productStatus = row.querySelector('td:nth-child(5) select').value;
     
     if (statusFilter === 'All' || productStatus === statusFilter) {
       row.style.display = '';
     } else {
       row.style.display = 'none'; 
     }
   });
   
   updatePaginationAfterFilter();
}

// Table pagination
let currentPage = 1;
const rowsPerPage = 10;

document.addEventListener("DOMContentLoaded", () => {
  initializePagination();
  
  // Initialize filter dropdown color
  const statusFilterEl = document.getElementById('statusFilter');
  if (statusFilterEl) {
    statusFilterEl.className = 'form-selects w-100 filter-' + statusFilterEl.value;
  }
});

function initializePagination() {
  showPage(1);
}

function getVisibleRows() {
  const table = document.getElementById("paginatedTable");
  const allRows = table.querySelectorAll("tbody tr");
  return Array.from(allRows).filter(row => row.style.display !== 'none');
}

function showPage(page) {
  const visibleRows = getVisibleRows();
  const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
  
  if (page < 1) page = 1;
  if (page > totalPages && totalPages > 0) page = totalPages;
  
  currentPage = page;
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;

  const table = document.getElementById("paginatedTable");
  const allRows = table.querySelectorAll("tbody tr");
  
  let visibleIndex = 0;
  allRows.forEach((row) => {
    if (row.style.display !== 'none') {
      if (visibleIndex >= start && visibleIndex < end) {
        row.classList.remove('pagination-hidden');
      } else {
        row.classList.add('pagination-hidden');
      }
      visibleIndex++;
    }
  });

  const tableInfo = document.getElementById("tableInfo");
  const actualStart = visibleRows.length > 0 ? start + 1 : 0;
  const actualEnd = Math.min(end, visibleRows.length);
  tableInfo.textContent = `Showing ${actualStart} to ${actualEnd} of ${visibleRows.length} entries`;

  updatePagination(totalPages);
}

function updatePagination(totalPages) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = ""; 

  if (totalPages <= 0) return;

  const createPageItem = (page, label, isDisabled = false, isActive = false) => {
    const li = document.createElement("li");
    li.className = `page-item ${isActive ? "active" : ""} ${isDisabled ? "disabled" : ""}`;
    li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
    li.addEventListener("click", (e) => {
      e.preventDefault();
      if (!isDisabled) {
        if (label === "Previous") {
          showPage(currentPage - 1);
        } else if (label === "Next") {
          showPage(currentPage + 1);
        } else {
          showPage(page);
        }
      }
    });
    return li;
  };

  pagination.appendChild(
    createPageItem(currentPage - 1, "Previous", currentPage === 1)
  );

  pagination.appendChild(
    createPageItem(currentPage + 1, "Next", currentPage === totalPages)
  );
}

function updatePaginationAfterFilter() {
  showPage(1);
}


// Print button
function printTable(userId) {
    if (!userId) return;
    
    var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
    if (!userRow) return;

    let now = new Date();
    let formattedDate = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    let formattedTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    let randomData = Math.random().toString(36).substr(2, 9);
    
    let userName = userRow.querySelector('.usr-name') ? userRow.querySelector('.usr-name').innerText : 'N/A';
    let userNumber = userRow.querySelector('.usr-select') ? userRow.querySelector('.usr-select').innerText : 'N/A';
    let productName = userRow.querySelector('.usr-location') ? userRow.querySelector('.usr-location').innerText : 'N/A';
    let price = userRow.querySelector('.usr-price') ? userRow.querySelector('.usr-price').innerText : 'N/A';
    let trackingId = userRow.querySelector('.usr-tracking-id') ? userRow.querySelector('.usr-tracking-id').innerText : 'N/A';
    let status = userRow.querySelector('.status-select') ? userRow.querySelector('.status-select').value : 'N/A';

    // Create simple invoice data for QR code
    const invoiceData = "REPAIR INVOICE\n" +
                       "Date: " + formattedDate + " " + formattedTime + "\n" +
                       "Ref: " + randomData + "\n" +
                       "Name: " + userName + "\n" +
                       "Number: " + userNumber + "\n" +
                       "Product: " + productName + "\n" +
                       "Price: " + price + "\n" +
                       "Tracking ID: " + trackingId + "\n" +
                       "Status: " + status + "\n" +
                       "ID: " + userId;
    let qrCodeURL = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(invoiceData);

    var printWindow = window.open('', 'PrintWindow', 'height=600,width=800');
    printWindow.document.write(`
        <html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                    h1 { text-align: center; color: #333; }
                    .date { display: flex; justify-content: space-between; margin: 20px; font-weight: bold; }
                    .dates { display: flex; justify-content: space-between; margin: 20px; border-bottom: 3px double #ccc; padding-bottom: 10px; }
                    .info-section { margin: 20px; display: flex; justify-content: space-around; border-bottom: 1px solid #ccc; padding-bottom: 20px; }
                    .info-section div { text-align: center; }
                    .info-section h5 { font-weight: bold; margin-bottom: 10px; }
                    .qr-code { margin-top: 50px; text-align: center; }
                    .qr-code img { width: 300px; height: 300px; }
                    .footer { margin-top: 100px; text-align: center; font-weight: bold; }
                </style>
            </head>
            <body>
                <h1>Repair Invoice</h1>
                <div class="date">
                    <p>Date: ${formattedDate}</p>
                    <p>Time: ${formattedTime}</p>
                </div>
                <div class="date">
                    <p>Name: ${userName}</p>
                    <p>Ref: ${randomData}</p>
                </div>
                <div class="dates">
                    <p>Number: ${userNumber}</p>
                </div>
                <div class="info-section">
                    <div><h5>Product</h5><p>${productName}</p></div>
                    <div><h5>Price</h5><p>${price}</p></div>
                    <div><h5>Tracking ID</h5><p>${trackingId}</p></div>
                    <div><h5>Status</h5><p>${status}</p></div>
                </div>
                <div class="qr-code">
                    <h3>QR Code</h3>
                    <img src="${qrCodeURL}" alt="QR Code" />
                </div>
                <div class="footer">
                    <p>Developed By ClickTake Technologies Â© 2025 DibNow</p>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.onload = function () {
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    };
}
</script>
    </body>
        <!-- JavaScript Libraries -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
    
        <!-- Template Javascript -->
        <script src="js/main.js"></script>
        <script src="js/updateStatus.js"></script>
    </html>



