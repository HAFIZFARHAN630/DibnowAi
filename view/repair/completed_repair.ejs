<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Completed Repairs</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="icon" href="\images\DIB-NOW-512.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="bootstrap.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link href="styles1.css" rel="stylesheet">
    <style>
      .body-wrapper { min-height: 100%; display: flex; flex-direction: column; }
      .footer { margin-top: auto; padding: 5px 80px 5px 30px; background-color: #dadae0; text-align: center; width: 109%; margin-left: -35px; }
      
      .table { border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border: none; }
      .table thead th { background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%); color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border: none; padding: 20px 15px; font-size: 14px; }
      .table tbody tr { transition: all 0.3s ease; border: none; }
      .table tbody tr:hover { background-color: #f8fff9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .table tbody td { padding: 18px 15px; border: none; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
      
      .status-badge { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; display: inline-block; }
      
      #text-srh { border-radius: 25px; background-color: #f8f9fa; border: 2px solid #e9ecef; color: #212529; padding: 10px 20px; font-size: 14px; transition: all 0.3s ease; }
      #text-srh:focus { background-color: #ffffff; border-color: #28a745; box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25); color: #212529; }
      #text-srh::placeholder { color: #6c757d; }
      
      .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; z-index: 10; }
      .search-input-wrapper { position: relative; }
      .search-input-wrapper input { padding-left: 45px; }
      .pagination-hidden { display: none !important; }
    </style>
</head>
<body>
  <%- include('../par/sidebar.ejs') %>
  <%- include('../par/header.ejs') %>

  <% if (success_msg.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong><i class="icon fa fa-check-circle me-2"></i><%= success_msg %></strong> 
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% } %>
  <% if (error_msg.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><%= error_msg %></strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% } %>

  <div class="body-wrapper" style="margin-top: 8rem !important;">
    <div class="">
      <div class="card card-body py-3">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
              <h4 class="mb-4 mb-sm-0 card-title">Completed Repairs</h4>
              
              <div class="search-container flex-grow-1" style="min-width:200px;">
                <div style="background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%); padding: 12px 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 51, 204, 0.3);">
                  <div class="search-input-wrapper w-100" style="position: relative;">
                    <i class="bi bi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #ffffff; z-index: 10;"></i>
                    <input type="text" id="text-srh" class="form-control" placeholder="Search Completed Repairs" style="padding-left: 40px; border-radius: 8px; border: none; height: 40px; color: #ffffff !important; background: rgba(255, 255, 255, 0.2) !important;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card card-body">
        <% if (products.length === 0) { %>
          <div class="text-center py-5">
            <i class="fas fa-info-circle" style="font-size: 64px; color: #17a2b8; opacity: 0.3;"></i>
<h5 class="mt-3 text-muted">No Completed Repairs Found</h5>
<p class="text-muted">You currently have no completed repairs. Once repairs are completed, they will be listed here automatically for your review.</p>

          </div>
        <% } else { %>
          <!-- Desktop Table -->
          <div class="table-responsive d-none d-xl-block">
            <table class="table search-table align-middle text-nowrap" id="completedTable">
              <thead class="header-item text-center">
                <tr>
                  <th>Tracking ID</th>
                  <th>Customer Name</th>
                  <th>Device / Product</th>
                  <th>Repair Price</th>
                  <th>Completion Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="table-body" class="text-center">
                <% products.forEach(product => { %>
                <tr class="search-items">
                  <td>
                    <span class="usr-tracking-id text-dark font-mono" style="font-size: 12px; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; display: inline-block;" title="Click to copy" onclick="copyToClipboard('<%= product.random_id %>')">
                      <%= product.random_id || 'N/A' %>
                    </span>
                  </td>
                  <td><span class="usr-name text-dark"><%= product.fullName %></span></td>
                  <td><span class="usr-product text-dark"><%= product.brand %></span></td>
                  <td><span class="usr-price text-dark">$<%= product.Price %></span></td>
                  <td><span class="usr-date text-dark"><%= new Date(product.updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></span></td>
                  <td><span class="status-badge">✅ Completed</span></td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>

          <!-- Mobile Cards -->
          <div class="d-block d-xl-none">
            <% products.forEach(product => { %>
            <div class="card mb-4 shadow-sm border-0 search-items">
              <div class="card-body">
                <h5 class="card-title mb-3 text-success">
                  <i class="fa fa-check-circle me-2"></i><%= product.fullName %>
                </h5>
                <p class="mb-2">
                  <span class="fw-semibold text-secondary">Tracking ID:</span>
                  <span class="font-mono text-primary" style="font-size: 14px; background: #f8f9fa; padding: 2px 6px; border-radius: 3px;" onclick="copyToClipboard('<%= product.random_id %>')" title="Click to copy">
                    <%= product.random_id || 'N/A' %>
                  </span>
                </p>
                <p class="mb-2"><span class="fw-semibold text-secondary">Device:</span> <%= product.brand %></p>
                <p class="mb-2"><span class="fw-semibold text-secondary">Price:</span> $<%= product.Price %></p>
                <p class="mb-2"><span class="fw-semibold text-secondary">Completed:</span> <%= new Date(product.updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></p>
                <span class="status-badge">✅ Completed</span>
              </div>
            </div>
            <% }); %>
          </div>

          <!-- Pagination -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <span id="tableInfo" class="text-muted">Showing 1 to <%= Math.min(10, products.length) %> of <%= products.length %> entries</span>
            <nav style="margin-right:31px;">
              <ul class="pagination" id="pagination"></ul>
            </nav>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <%- include('../par/footer.ejs') %>

  <script>
    // Copy tracking ID to clipboard
    function copyToClipboard(text) {
      if (text && text !== 'N/A') {
        navigator.clipboard.writeText(text).then(() => {
          showNotification('Tracking ID copied!', 'success');
        }).catch(() => {
          showNotification('Failed to copy', 'error');
        });
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
      notification.style.zIndex = '9999';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // Search functionality
    document.getElementById('text-srh').addEventListener('keyup', function () {
      const searchTerm = this.value.toLowerCase().trim();
      const tableRows = document.querySelectorAll('.search-items');

      tableRows.forEach(row => {
        const trackingId = row.querySelector('.usr-tracking-id')?.textContent.toLowerCase() || '';
        const name = row.querySelector('.usr-name')?.textContent.toLowerCase() || '';
        const product = row.querySelector('.usr-product')?.textContent.toLowerCase() || '';
        const price = row.querySelector('.usr-price')?.textContent.toLowerCase() || '';

        if (searchTerm === '' || trackingId.includes(searchTerm) || name.includes(searchTerm) || product.includes(searchTerm) || price.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      updatePaginationAfterFilter();
    });

    // Pagination
    let currentPage = 1;
    const rowsPerPage = 10;

    document.addEventListener("DOMContentLoaded", () => {
      if (document.querySelectorAll('.search-items').length > 0) {
        initializePagination();
      }
    });

    function initializePagination() {
      showPage(1);
    }

    function getVisibleRows() {
      const tableRows = document.querySelectorAll('#completedTable .search-items');
      const cardRows = document.querySelectorAll('.d-block.d-xl-none .search-items');
      const allRows = tableRows.length > 0 ? tableRows : cardRows;
      return Array.from(allRows).filter(row => row.style.display !== 'none');
    }

    function showPage(page) {
      const visibleRows = getVisibleRows();
      const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
      
      if (page < 1) page = 1;
      if (page > totalPages && totalPages > 0) page = totalPages;
      
      currentPage = page;
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;

      const tableRows = document.querySelectorAll('#completedTable .search-items');
      const cardRows = document.querySelectorAll('.d-block.d-xl-none .search-items');
      const allRows = tableRows.length > 0 ? tableRows : cardRows;
      
      let visibleIndex = 0;
      allRows.forEach((row) => {
        if (row.style.display !== 'none') {
          if (visibleIndex >= start && visibleIndex < end) {
            row.classList.remove('pagination-hidden');
          } else {
            row.classList.add('pagination-hidden');
          }
          visibleIndex++;
        }
      });

      const tableInfo = document.getElementById("tableInfo");
      if (tableInfo) {
        const actualStart = visibleRows.length > 0 ? start + 1 : 0;
        const actualEnd = Math.min(end, visibleRows.length);
        tableInfo.textContent = `Showing ${actualStart} to ${actualEnd} of ${visibleRows.length} entries`;
      }

      updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
      const pagination = document.getElementById("pagination");
      if (!pagination) return;
      
      pagination.innerHTML = "";

      if (totalPages <= 1) return;

      const createPageItem = (page, label, isDisabled = false) => {
        const li = document.createElement("li");
        li.className = `page-item ${isDisabled ? "disabled" : ""}`;
        li.innerHTML = `<a class="page-link" href="#" style="background: linear-gradient(135deg, #0033cc 0%, #33ccff 100%); color: white; border: none; font-weight: 600; padding: 10px 24px; min-width: 120px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 51, 204, 0.3);">${label}</a>`;
        li.addEventListener("click", (e) => {
          e.preventDefault();
          if (!isDisabled) {
            if (label === "Previous") showPage(currentPage - 1);
            else if (label === "Next") showPage(currentPage + 1);
            else showPage(page);
          }
        });
        return li;
      };

      pagination.appendChild(createPageItem(currentPage - 1, "Previous", currentPage === 1));
      pagination.appendChild(createPageItem(currentPage + 1, "Next", currentPage === totalPages));
    }

    function updatePaginationAfterFilter() {
      showPage(1);
    }
  </script>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
